<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>TR·∫†M C√Ä PH√ä</title>
<style>
  body{font-family:sans-serif;margin:0;padding:0;background:#f8f5f2}
  header{background:#6f4e37;color:#fff;text-align:center;padding:15px;font-size:28px;font-weight:bold}
  nav{display:flex;justify-content:center;background:#d7ccc8}
  nav button{padding:15px 25px;font-size:18px;border:none;background:none;cursor:pointer}
  nav button.active{background:#a1887f;color:#fff}
  section{padding:20px}
  .hidden{display:none}

  /* Menu & card */
  .card{border:1px solid #ccc;border-radius:8px;padding:15px;margin:8px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{padding:10px 20px;font-size:18px;border:none;border-radius:6px;cursor:pointer}
  .btn.primary{background:#6f4e37;color:#fff}
  .btn.success{background:#2e7d32;color:#fff}
  .btn.danger{background:#c62828;color:#fff}

  table{border-collapse:collapse;width:100%;margin-top:10px}
  th,td{border:1px solid #aaa;padding:8px;font-size:18px;text-align:center}

  /* B√°n h√†ng */
  .menu-btn{display:block;width:100%;padding:20px;font-size:24px;margin:10px 0;
            border-radius:10px;border:2px solid #6f4e37;background:#fff;cursor:pointer}
  .menu-btn:hover{background:#f0e6dd}
  .sold-btn{position:sticky;top:0;left:50%;transform:translateX(-50%);
            width:80%;padding:16px;font-size:22px;background:#2e7d32;color:#fff;
            border:none;border-radius:10px;cursor:pointer;margin-bottom:15px}
  .popup{position:fixed;top:0;left:0;width:100%;height:100%;
         background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;
         z-index:1000;display:none}
  .popup-content{background:#fff;padding:20px;border-radius:12px;width:320px;text-align:center;font-size:20px}
  .popup-content input{font-size:22px;padding:8px;margin:12px 0;width:100%}
  .highlight{background:#fff3cd!important}
</style>
</head>
<body>
<header>TR·∫†M C√Ä PH√ä</header>
<nav>
  <button onclick="showTab('menu')">Qu·∫£n l√Ω Menu</button>
  <button onclick="showTab('banhang')">B√°n h√†ng</button>
  <button onclick="showTab('nhapkho')">Nh·∫≠p kho</button>
  <button onclick="showTab('baocao')">B√°o c√°o</button>
</nav>

<!-- Qu·∫£n l√Ω Menu -->
<section id="menu" class="hidden">
  <h3>Th√™m / s·ª≠a m√≥n</h3>
  <div class="row">
    <input id="menu-ten" type="text" placeholder="T√™n m√≥n" />
    <input id="menu-gia" type="number" min="1000" step="1000" placeholder="Gi√° (VNƒê)" />
    <button id="menu-save" class="btn primary">L∆∞u</button>
    <button id="menu-cancel" class="btn danger hidden">H·ªßy</button>
    <input id="menu-file" type="file" accept=".csv" style="display:none" />
    <button id="menu-import" class="btn success">Import CSV</button>
    <button onclick="exportMenuExcel()" class="btn">Export Excel</button>
  </div>
  <h3>Danh s√°ch menu</h3>
  <div id="menu-list"></div>
</section>

<!-- B√°n h√†ng -->
<section id="banhang" class="hidden">
  <button class="sold-btn" onclick="toggleSold()">üì¶ ƒê√£ b√°n trong ng√†y</button>
  <div id="ban-grid"></div>
  <div id="sold-list" style="display:none;margin-top:15px"></div>
</section>

<!-- Popup nh·∫≠p s·ªë l∆∞·ª£ng -->
<div id="sell-popup" class="popup">
  <div class="popup-content">
    <h3 id="popup-name"></h3>
    <p>Gi√°: <span id="popup-price"></span></p>
    <input type="number" id="popup-qty" min="1" value="1">
    <div style="margin-top:15px">
      <button class="btn primary" onclick="confirmSell()">X√°c nh·∫≠n</button>
      <button class="btn danger" onclick="closePopup()">H·ªßy</button>
    </div>
  </div>
</div>

<!-- Nh·∫≠p kho -->
<section id="nhapkho" class="hidden">
  <h3>Nh·∫≠p h√†ng</h3>
  <div class="row">
    <input id="nk-ten" type="text" placeholder="T√™n nguy√™n li·ªáu" />
    <input id="nk-sl" type="number" min="1" placeholder="S·ªë l∆∞·ª£ng" />
    <input id="nk-gia" type="number" min="1000" step="100" placeholder="ƒê∆°n gi√° (VNƒê)" />
    <button onclick="addNhapKho()" class="btn primary">Th√™m</button>
  </div>
  <h3>Danh s√°ch nh·∫≠p kho</h3>
  <div id="nk-list"></div>
</section>

<!-- B√°o c√°o -->
<section id="baocao" class="hidden">
  <h3>B√°o c√°o doanh thu & l·ª£i nhu·∫≠n</h3>
  <div id="report"></div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const LS_MENU="tram_menu",LS_SALES="tram_sales",LS_NHAP="tram_nhap";
let menu=load(LS_MENU,[]),sales=load(LS_SALES,[]),nhapkho=load(LS_NHAP,[]);
const fmt=new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"});
function qs(s){return document.querySelector(s)}
function load(k,d){return JSON.parse(localStorage.getItem(k)||JSON.stringify(d))}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function showTab(id){document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  qs("#"+id).classList.remove("hidden");
  event.target.classList.add("active");
  if(id==="menu")renderMenu();
  if(id==="banhang")renderBanHang();
  if(id==="nhapkho")renderNhapKho();
  if(id==="baocao")renderReport();
}

/* ===== MENU ===== */
function renderMenu(){
  const list=qs("#menu-list");list.innerHTML="";
  menu.forEach((m,i)=>{
    const d=document.createElement("div");d.className="card";
    d.innerHTML=`<b>${m.ten}</b> - ${fmt.format(m.gia)}
      <button class="btn" onclick="editMenu(${i})">S·ª≠a</button>
      <button class="btn danger" onclick="delMenu(${i})">X√≥a</button>`;
    list.appendChild(d);
  });
}
qs("#menu-save").onclick=()=>{
  const ten=qs("#menu-ten").value.trim(),gia=+qs("#menu-gia").value;
  if(!ten||isNaN(gia)||gia<1000){alert("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá");return;}
  const idx=qs("#menu-save").dataset.edit;
  if(idx){menu[idx].ten=ten;menu[idx].gia=gia;delete qs("#menu-save").dataset.edit}
  else menu.push({ten,gia});
  save(LS_MENU,menu);qs("#menu-ten").value=qs("#menu-gia").value="";
  qs("#menu-cancel").classList.add("hidden");renderMenu();renderBanHang();
};
function editMenu(i){
  qs("#menu-ten").value=menu[i].ten;qs("#menu-gia").value=menu[i].gia;
  qs("#menu-save").dataset.edit=i;qs("#menu-cancel").classList.remove("hidden");
}
qs("#menu-cancel").onclick=()=>{qs("#menu-ten").value=qs("#menu-gia").value="";
  delete qs("#menu-save").dataset.edit;qs("#menu-cancel").classList.add("hidden");}
function delMenu(i){if(confirm("X√≥a m√≥n?")){menu.splice(i,1);save(LS_MENU,menu);renderMenu();renderBanHang();}}
qs("#menu-import").onclick=()=>qs("#menu-file").click();
qs("#menu-file").onchange=e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    const lines=ev.target.result.split(/\r?\n/).filter(l=>l.trim());
    lines.forEach(l=>{
      const [ten,gia]=l.split(",");
      if(ten&&gia&&!isNaN(+gia))menu.push({ten:ten.trim(),gia:+gia});
    });
    save(LS_MENU,menu);renderMenu();renderBanHang();
  };r.readAsText(f,"UTF-8");
};
function exportMenuExcel(){
  const ws=XLSX.utils.json_to_sheet(menu);
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Menu");
  XLSX.writeFile(wb,"menu.xlsx");
}

/* ===== B√ÅN H√ÄNG ===== */
let currentItem=null,lastSoldId=null;
function renderBanHang(){
  const grid=qs("#ban-grid");grid.innerHTML="";
  menu.forEach(m=>{
    const btn=document.createElement("button");
    btn.className="menu-btn";btn.textContent=m.ten;
    btn.onclick=()=>openPopup(m);grid.appendChild(btn);
  });
  renderSold();
}
function openPopup(item){currentItem=item;
  qs("#popup-name").textContent=item.ten;
  qs("#popup-price").textContent=fmt.format(item.gia);
  qs("#popup-qty").value=1;qs("#sell-popup").style.display="flex";}
function closePopup(){qs("#sell-popup").style.display="none";}
function confirmSell(){
  const sl=+qs("#popup-qty").value;
  if(isNaN(sl)||sl<1){alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá");return;}
  const ts=Date.now(),id="s"+ts;
  sales.push({id,ten:currentItem.ten,gia:currentItem.gia,sl,ts});
  save(LS_SALES,sales);lastSoldId=id;closePopup();renderSold();
}
function toggleSold(){qs("#sold-list").style.display=(qs("#sold-list").style.display==="none")?"block":"none";}
function renderSold(){
  const today=new Date();today.setHours(0,0,0,0);
  const sold=sales.filter(s=>s.ts>=today.getTime());
  const list=qs("#sold-list");if(!sold.length){list.innerHTML="<i>Ch∆∞a b√°n h√¥m nay</i>";return}
  let tong=0,html="<table><tr><th>M√≥n</th><th>SL</th><th>Th√†nh ti·ªÅn</th><th></th></tr>";
  sold.forEach((s,i)=>{
    const tt=s.sl*s.gia;tong+=tt;
    const hl=(s.id===lastSoldId)?"highlight":"";
    html+=`<tr class="${hl}">
      <td>${s.ten}</td>
      <td><input type="number" value="${s.sl}" min="1" style="font-size:18px;width:70px" onchange="editSold(${i},this.value)"></td>
      <td>${fmt.format(tt)}</td>
      <td><button class="btn danger" onclick="removeSold(${i})">X</button></td></tr>`;
  });
  html+=`<tr><th colspan=2>T·ªïng</th><th>${fmt.format(tong)}</th><th></th></tr></table>`;
  list.innerHTML=html;
}
function editSold(i,val){val=+val;if(isNaN(val)||val<1){alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá");renderSold();return;}
  sales[i].sl=val;save(LS_SALES,sales);renderSold();}
function removeSold(i){if(confirm("X√≥a m·ª•c n√†y?")){sales.splice(i,1);save(LS_SALES,sales);renderSold();}}

/* ===== NH·∫¨P KHO ===== */
function addNhapKho(){
  const ten=qs("#nk-ten").value.trim(),sl=+qs("#nk-sl").value,gia=+qs("#nk-gia").value;
  if(!ten||isNaN(sl)||sl<1||isNaN(gia)||gia<1000){alert("Sai d·ªØ li·ªáu");return;}
  nhapkho.push({ten,sl,gia,ts:Date.now()});save(LS_NHAP,nhapkho);qs("#nk-ten").value=qs("#nk-sl").value=qs("#nk-gia").value="";renderNhapKho();
}
function renderNhapKho(){
  const list=qs("#nk-list");if(!nhapkho.length){list.innerHTML="<i>Ch∆∞a nh·∫≠p kho</i>";return}
  let tong=0,html="<table><tr><th>Nguy√™n li·ªáu</th><th>SL</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th></tr>";
  nhapkho.forEach(n=>{const tt=n.sl*n.gia;tong+=tt;
    html+=`<tr><td>${n.ten}</td><td>${n.sl}</td><td>${fmt.format(n.gia)}</td><td>${fmt.format(tt)}</td></tr>`});
  html+=`<tr><th colspan=3>T·ªïng</th><th>${fmt.format(tong)}</th></tr></table>`;list.innerHTML=html;
}

/* ===== B√ÅO C√ÅO ===== */
function renderReport(){
  const today=new Date();today.setHours(0,0,0,0);
  function sumSales(fn){return sales.filter(fn).reduce((a,b)=>a+b.sl*b.gia,0);}
  function sumNhap(fn){return nhapkho.filter(fn).reduce((a,b)=>a+b.sl*b.gia,0);}
  const weekStart=new Date(today);weekStart.setDate(weekStart.getDate()-weekStart.getDay());
  const monthStart=new Date(today.getFullYear(),today.getMonth(),1);
  const yearStart=new Date(today.getFullYear(),0,1);
  const html=`
    <table>
    <tr><th>Kho·∫£ng</th><th>Doanh thu</th><th>Chi ph√≠</th><th>L·ª£i nhu·∫≠n</th></tr>
    <tr><td>Tu·∫ßn</td><td>${fmt.format(sumSales(s=>s.ts>=weekStart.getTime()))}</td>
        <td>${fmt.format(sumNhap(n=>n.ts>=weekStart.getTime()))}</td>
        <td>${fmt.format(sumSales(s=>s.ts>=weekStart.getTime())-sumNhap(n=>n.ts>=weekStart.getTime()))}</td></tr>
    <tr><td>Th√°ng</td><td>${fmt.format(sumSales(s=>s.ts>=monthStart.getTime()))}</td>
        <td>${fmt.format(sumNhap(n=>n.ts>=monthStart.getTime()))}</td>
        <td>${fmt.format(sumSales(s=>s.ts>=monthStart.getTime())-sumNhap(n=>n.ts>=monthStart.getTime()))}</td></tr>
    <tr><td>NƒÉm</td><td>${fmt.format(sumSales(s=>s.ts>=yearStart.getTime()))}</td>
        <td>${fmt.format(sumNhap(n=>n.ts>=yearStart.getTime()))}</td>
        <td>${fmt.format(sumSales(s=>s.ts>=yearStart.getTime())-sumNhap(n=>n.ts>=yearStart.getTime()))}</td></tr>
    </table>`;
  qs("#report").innerHTML=html;
}
showTab('menu');
</script>
</body>
</html>
