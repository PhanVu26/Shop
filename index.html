<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TRẠM CÀ PHÊ</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f7f3ee;margin:0;color:#2b2a28;font-size:20px}
  header{background:#6f4e37;color:#fff;padding:15px;position:sticky;top:0}
  header h1{margin:0;font-size:28px}
  .tabs{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .tab-btn{background:#fff;color:#6f4e37;border:none;padding:14px 20px;border-radius:8px;cursor:pointer;font-size:18px}
  .tab-btn.active{background:#2b2a28;color:#fff}
  main{padding:20px}
  .hidden{display:none}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
  .card{background:#fff;border:2px solid #aaa;padding:16px;border-radius:10px;font-size:20px}
  h3{margin-top:0;font-size:24px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px}
  input[type=number],input[type=text]{padding:10px;border:2px solid #aaa;border-radius:6px;font-size:18px}
  .btn{padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-size:18px}
  .btn.primary{background:#6f4e37;color:#fff}
  .btn.danger{background:#b71c1c;color:#fff}
  .btn.success{background:#2e7d32;color:#fff}
  .btn.warning{background:#f57c00;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:16px;font-size:18px}
  th,td{border:1px solid #ccc;padding:10px;text-align:left}
  th{background:#eee}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <h1>☕ TRẠM CÀ PHÊ</h1>
  <div class="tabs">
    <button class="tab-btn active" data-tab="banhang">Bán hàng</button>
    <button class="tab-btn" data-tab="menu">Quản lý menu</button>
    <button class="tab-btn" data-tab="baocao">Báo cáo</button>
    <button class="tab-btn" data-tab="caidat">Cài đặt</button>
  </div>
</header>

<main>
  <!-- BÁN HÀNG -->
  <section id="banhang">
    <h3>Danh sách món</h3>
    <div id="ban-grid" class="grid"></div>

    <h3>Hóa đơn hôm nay</h3>
    <div id="ban-table"></div>
  </section>

  <!-- MENU -->
  <section id="menu" class="hidden">
    <h3>Thêm / sửa món</h3>
    <div class="row">
      <input id="menu-ten" type="text" placeholder="Tên món (VD: Cà phê đen)" />
      <input id="menu-gia" type="number" placeholder="Giá (VNĐ)" />
      <button id="menu-save" class="btn primary">Lưu</button>
      <button id="menu-cancel" class="btn danger hidden">Hủy</button>
    </div>
    <h3>Danh sách menu</h3>
    <div id="menu-list"></div>
  </section>

  <!-- BÁO CÁO -->
  <section id="baocao" class="hidden">
    <h3>Báo cáo doanh thu</h3>
    <div class="row">
      <label>Chọn kỳ:</label>
      <select id="ky" style="font-size:18px;padding:6px">
        <option value="day">Hôm nay</option>
        <option value="week">Tuần này</option>
        <option value="month">Tháng này</option>
        <option value="year">Năm nay</option>
      </select>
      <button id="btn-export" class="btn success">Xuất Excel</button>
    </div>
    <div id="report"></div>
  </section>

  <!-- CÀI ĐẶT -->
  <section id="caidat" class="hidden">
    <h3>Dữ liệu</h3>
    <button id="btn-clear" class="btn danger">Xóa toàn bộ dữ liệu</button>
  </section>
</main>

<script>
const LS_MENU="cf_menu", LS_SALES="cf_sales";
const fmt=new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",maximumFractionDigits:0});
const qs=s=>document.querySelector(s); const qsa=s=>document.querySelectorAll(s);

function load(k){try{return JSON.parse(localStorage.getItem(k))||[]}catch{return[]}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
let menu=load(LS_MENU), sales=load(LS_SALES);

let editingIndex=null;

// Tabs
qsa(".tab-btn").forEach(b=>b.onclick=()=>{
  qsa(".tab-btn").forEach(x=>x.classList.remove("active")); b.classList.add("active");
  qsa("main section").forEach(s=>s.classList.add("hidden"));
  qs("#"+b.dataset.tab).classList.remove("hidden");
  if(b.dataset.tab==="banhang") renderBanHang();
  if(b.dataset.tab==="menu") renderMenu();
  if(b.dataset.tab==="baocao") renderReport();
});

// Menu
function renderMenu(){
  const list=qs("#menu-list"); list.innerHTML="";
  menu.forEach((m,i)=>{
    const div=document.createElement("div");
    div.className="row"; 
    div.innerHTML=`<div style="flex:1">${m.ten} - ${fmt.format(m.gia)}</div>
      <button class="btn warning">Sửa</button>
      <button class="btn danger">Xóa</button>`;
    div.querySelector(".btn.danger").onclick=()=>{
      if(confirm("Xóa món này?")){menu.splice(i,1);save(LS_MENU,menu);renderMenu();renderBanHang();}
    }
    div.querySelector(".btn.warning").onclick=()=>{
      editingIndex=i;
      qs("#menu-ten").value=m.ten;
      qs("#menu-gia").value=m.gia;
      qs("#menu-save").textContent="Cập nhật";
      qs("#menu-cancel").classList.remove("hidden");
    }
    list.appendChild(div);
  })
}
qs("#menu-save").onclick=()=>{
  const ten=qs("#menu-ten").value.trim(), gia=+qs("#menu-gia").value;
  if(!ten||gia<=0){alert("Nhập tên và giá hợp lệ");return}
  if(editingIndex!==null){
    menu[editingIndex]={ten,gia};
    editingIndex=null;
    qs("#menu-save").textContent="Lưu";
    qs("#menu-cancel").classList.add("hidden");
  } else {
    menu.push({ten,gia});
  }
  save(LS_MENU,menu);
  qs("#menu-ten").value="";qs("#menu-gia").value="";
  renderMenu();renderBanHang();
}
qs("#menu-cancel").onclick=()=>{
  editingIndex=null;
  qs("#menu-ten").value="";qs("#menu-gia").value="";
  qs("#menu-save").textContent="Lưu";
  qs("#menu-cancel").classList.add("hidden");
}

// Bán hàng
function renderBanHang(){
  const grid=qs("#ban-grid"); grid.innerHTML="";
  menu.forEach(m=>{
    const c=document.createElement("div"); c.className="card";
    c.innerHTML=`<b>${m.ten}</b><br>${fmt.format(m.gia)}<div class="row">
      <input type="number" min="1" value="1" style="width:80px"><button class="btn success">Bán</button></div>`;
    const inp=c.querySelector("input");
    c.querySelector("button").onclick=()=>{
      const sl=+inp.value||1;
      sales.push({ten:m.ten,gia:m.gia,sl,ts:Date.now()});
      save(LS_SALES,sales); renderHoaDon();
    };
    grid.appendChild(c);
  });
  renderHoaDon();
}
function renderHoaDon(){
  const today=new Date();today.setHours(0,0,0,0);
  const data=sales.filter(s=>s.ts>=today.getTime());
  if(!data.length){qs("#ban-table").innerHTML="<i>Chưa có bán hàng hôm nay</i>";return}
  let tong=0, html="<table><tr><th>Món</th><th>SL</th><th>Thành tiền</th></tr>";
  data.forEach(s=>{const t=s.sl*s.gia; tong+=t; html+=`<tr><td>${s.ten}</td><td>${s.sl}</td><td>${fmt.format(t)}</td></tr>`});
  html+=`<tr><th colspan=2>Tổng</th><th>${fmt.format(tong)}</th></tr></table>`;
  qs("#ban-table").innerHTML=html;
}

// Báo cáo
function getRange(ky){
  let start=new Date(),end=new Date();
  if(ky==="day"){start.setHours(0,0,0,0); end.setHours(23,59,59,999);}
  if(ky==="week"){const d=start.getDay();start.setDate(start.getDate()-d+1);start.setHours(0,0,0,0);end=new Date(start);end.setDate(start.getDate()+6);end.setHours(23,59,59,999);}
  if(ky==="month"){start=new Date(start.getFullYear(),start.getMonth(),1);end=new Date(start.getFullYear(),start.getMonth()+1,0);}
  if(ky==="year"){start=new Date(start.getFullYear(),0,1);end=new Date(start.getFullYear(),11,31);}
  return {start,end};
}
function renderReport(){
  const ky=qs("#ky").value; const {start,end}=getRange(ky);
  const data=sales.filter(s=>s.ts>=start.getTime() && s.ts<=end.getTime());
  if(!data.length){qs("#report").innerHTML="<i>Không có dữ liệu</i>";return}
  let tong=0, html="<table><tr><th>Món</th><th>SL</th><th>Doanh thu</th></tr>";
  const agg={};
  data.forEach(s=>{if(!agg[s.ten])agg[s.ten]={sl:0,dt:0};agg[s.ten].sl+=s.sl;agg[s.ten].dt+=s.sl*s.gia;})
  Object.entries(agg).forEach(([ten,v])=>{tong+=v.dt;html+=`<tr><td>${ten}</td><td>${v.sl}</td><td>${fmt.format(v.dt)}</td></tr>`})
  html+=`<tr><th colspan=2>Tổng</th><th>${fmt.format(tong)}</th></tr></table>`;
  qs("#report").innerHTML=html;
}
qs("#ky").onchange=renderReport;

// Xuất Excel
qs("#btn-export").onclick=()=>{
  const ky=qs("#ky").value; const {start,end}=getRange(ky);
  const data=sales.filter(s=>s.ts>=start.getTime() && s.ts<=end.getTime());
  if(!data.length){alert("Không có dữ liệu để xuất");return}
  const agg={}; let tong=0;
  data.forEach(s=>{if(!agg[s.ten])agg[s.ten]={sl:0,dt:0};agg[s.ten].sl+=s.sl;agg[s.ten].dt+=s.sl*s.gia;})
  const rows=[["Món","Số lượng","Doanh thu"]];
  Object.entries(agg).forEach(([ten,v])=>{rows.push([ten,v.sl,v.dt]); tong+=v.dt;});
  rows.push(["Tổng","",tong]);
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"BaoCao");
  XLSX.writeFile(wb,`BaoCao_${ky}.xlsx`);
};

// Cài đặt
qs("#btn-clear").onclick=()=>{if(confirm("Xóa toàn bộ dữ liệu?")){localStorage.clear();menu=[];sales=[];renderBanHang();renderMenu();renderReport();}}

// Khởi tạo
renderBanHang(); renderMenu(); renderReport();
</script>
</body>
</html>
