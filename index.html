<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>TRẠM CÀ PHÊ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<style>
html { font-size: 16px; }
body {
    font-family: 'Quicksand', Arial, sans-serif;
    margin: 0;
    background: #f7f2ee;
    color: #2d2d2d;
    min-height: 100vh;
}
nav {
    display: flex;
    justify-content: space-between;
    background: #6f4e37;
    color: #fff;
    padding: 0;
    box-shadow: 0 1px 8px rgba(0,0,0,0.06);
    position: sticky;
    top: 0; z-index: 100;
}
nav button {
    flex: 1;
    padding: 1.1em 0;
    font-size: 1.15rem;
    border: none;
    background: inherit;
    color: #fff;
    cursor: pointer;
    outline: none;
    font-weight: 600;
    transition: background .15s;
    letter-spacing: .01em;
}
nav button.active { background: #8d6e63; }
nav button:active { background: #a1887f; }

section {
    padding: 18px 8px 60px 8px;
    max-width: 480px;
    margin: 0 auto;
}

h2, h3 {
    font-weight: 700;
    margin-top: 0.2em;
    margin-bottom: 0.6em;
    color: #4e342e;
}
h2 { font-size: 1.45rem; }
h3 { font-size: 1.1rem; }

input, select, button, textarea {
    font-family: inherit;
    font-size: 1.06rem;
    border-radius: 7px;
    border: 1px solid #c1b2a6;
    margin: 4px 0;
    box-sizing: border-box;
    transition: border .13s;
}
input:focus, select:focus, textarea:focus {
    outline: none;
    border: 1.5px solid #8d6e63;
    background: #f5ede5;
}
input[type="number"]::-webkit-inner-spin-button{ opacity:0.8; }

input, select {
    padding: 9px 10px;
    width: 100%;
    margin-bottom: 8px;
    font-size: 1.08rem;
}
button {
    padding: 10px 18px;
    font-size: 1.08rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    margin-right: 6px;
    margin-bottom: 4px;
}
.btn.primary { background: #1976d2; color: #fff; }
.btn.danger { background: #d32f2f; color: #fff; }
.btn.success { background: #388e3c; color: #fff; }
.btn.secondary { background: #8d6e63; color: #fff; }
button[disabled], .btn[disabled] {
    opacity: 0.6;
    pointer-events: none;
}

.menu-search-bar {
  margin-bottom: 10px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  position: relative;
}
.menu-search-input {
  font-size: 1.08em;
  padding: 8px 12px;
  border: 1.5px solid #8d6e63;
  border-radius: 7px;
  width: 100%;
}
.menu-search-dropdown {
  position: absolute;
  background: #fff;
  border: 1px solid #c1b2a6;
  border-radius: 7px;
  z-index: 10;
  left: 0;
  right: 0;
  box-shadow: 0 2px 8px rgba(111,78,55,.08);
  max-height: 180px;
  overflow-y: auto;
  top: 40px;
}
.menu-search-dropdown div {
  padding: 8px 14px;
  cursor: pointer;
}
.menu-search-dropdown div:hover {
  background: #f5ede5;
}
.menu-row-list { display: flex; flex-direction: column; gap: 12px; }
.menu-row-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fff;
  border: 2px solid #6f4e37;
  border-radius: 13px;
  padding: 14px 10px;
  font-size: 1.14em;
  font-weight: 600;
  box-shadow: 0 2px 10px rgba(111,78,55,.07);
  cursor: pointer;
  transition: background 0.12s;
}
.menu-row-item:hover {
  background: #f0e6dd;
}
.menu-row-item .item-name { flex: 1 1 auto; }
.menu-row-item .item-price {
  color: #8d6e63;
  font-size: 0.98em;
  min-width: 90px;
  text-align: right;
  margin-left: 8px;
}
.menu-row-item button {
  margin-left: 8px; font-size: 1em; padding: 7px 13px;
  cursor: pointer;
}

.menu-pagination-bar {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 10px;
}
.menu-pagination-bar select {
  padding: 3px 7px;
  font-size: 1em;
  border-radius: 6px;
}

/* Sold Items Button */
#sold-items-btn {
  position: sticky;
  top: 0;
  left: 0;
  z-index: 50;
  background: #1976d2;
  color: #fff;
  width: 100%;
  font-size: 1.08em;
  border-radius: 0 0 12px 12px;
  padding: 13px 0;
  box-shadow: 0 2px 8px rgba(25,118,210,0.07);
  border: none;
  font-weight: bold;
  letter-spacing: 0.01em;
  margin-bottom: 10px;
  transition: background .12s;
}
#sold-items-btn:hover { background: #388e3c; }

.sold-modal {
  position: fixed;
  z-index: 2000;
  top: 0; left: 0; width:100vw;height:100vh;
  background: rgba(0,0,0,0.35);
  display: none;
  align-items: center;
  justify-content: center;
}
.sold-modal-content {
  background: #fff;
  padding: 18px 10px 10px 10px;
  border-radius: 15px;
  max-width: 400px;
  width: 96vw;
  box-shadow: 0 2px 16px #6f4e3770;
}
.sold-modal-content h3 {
  margin: 0 0 1em 0;
  text-align: center;
}
.sold-modal-close {
  position: absolute;
  right: 18px;
  top: 10px;
  font-size: 1.5em;
  color: #d32f2f;
  cursor: pointer;
  background: none;
  border: none;
}
.sold-modal-table th, .sold-modal-table td {
  font-size: 1.03em;
  padding: 7px 4px;
  border: 1px solid #f0e6dd;
}
.sold-modal-table th { background: #f5ede5; }
.sold-modal-highlight { background: #fff3cd !important; }
.sold-modal-pagination {
  display: flex; align-items: center; justify-content: center;
  gap: 10px; margin: 10px 0;
}
.sold-modal-summary {
  margin-top: 10px;
  text-align: center;
  font-weight: bold;
  color: #1976d2;
  font-size: 1.08em;
}
.sold-modal-summary span { margin: 0 13px; }

/* Editable Nhập kho */
.nhap-table-btns button {
  font-size: 0.98em;
  padding: 6px 10px;
}
.nhap-table-editing input[type="text"], .nhap-table-editing input[type="number"] {
  width: 85px;
  margin-bottom: 0;
  font-size: 0.98em;
  padding: 4px 6px;
}
.nhap-table-editing td { background: #faf6f2; }

@media (max-width: 480px) {
    html { font-size: 15px; }
    section { padding: 13px 3px 60px 3px; }
}
@media (max-width: 400px) {
    .popup-content { padding: 15px 3vw; }
}

input.error, select.error {
    border: 2px solid #d32f2f !important;
    background: #fff8f8;
}
.msg-err {
    color: #d32f2f;
    font-size: .99em;
    margin: 0 0 6px 0;
    text-align: left;
}

.sold-input-qty {
    width: 60px !important;
    text-align: center;
    font-size: 1.07em;
    padding: 4px 2px;
}
tr:last-child th, tr:last-child td { border-bottom: none; }

.highlight-positive { color: #388e3c; font-weight: bold; }
.highlight-negative { color: #d32f2f; font-weight: bold; }
</style>
</head>
<body>
<nav>
  <button onclick="openTab('banhang')" id="tab-banhang" class="active">Bán hàng</button>
  <button onclick="openTab('menu')">Menu</button>
  <button onclick="openTab('nhapkho')">Nhập kho</button>
  <button onclick="openTab('baocao')">Báo cáo</button>
  <button onclick="openTab('caidat')">Cài đặt</button>
</nav>

<!-- Bán hàng -->
<section id="banhang">
  <button id="sold-items-btn" onclick="openSoldModal()">Xem Đã bán hôm nay</button>
  <h2>Bán hàng</h2>
  <div class="menu-search-bar">
    <input class="menu-search-input" id="menu-search" placeholder="Tìm món..." autocomplete="off" oninput="renderBanHang()">
    <div id="menu-search-dropdown" class="menu-search-dropdown" style="display:none"></div>
    <div class="menu-pagination-bar">
      <span>Hiển thị:</span>
      <select id="menu-page-size" onchange="renderBanHang()">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="all">Tất cả</option>
      </select>
      <button id="menu-prev" onclick="changeMenuPage(-1)">&lt;</button>
      <span id="menu-page-info"></span>
      <button id="menu-next" onclick="changeMenuPage(1)">&gt;</button>
    </div>
  </div>
  <div class="menu-row-list" id="ban-row-list"></div>
</section>

<!-- Sold Items Modal -->
<div class="sold-modal" id="sold-modal">
  <div class="sold-modal-content" style="position:relative;">
    <button class="sold-modal-close" onclick="closeSoldModal()" title="Đóng">×</button>
    <h3>Đã bán hôm nay</h3>
    <div id="sold-modal-list"></div>
    <div class="sold-modal-pagination">
      <button onclick="soldModalPageChange(-1)" id="sold-modal-prev">&lt;</button>
      <span id="sold-modal-page-info"></span>
      <button onclick="soldModalPageChange(1)" id="sold-modal-next">&gt;</button>
    </div>
    <div class="sold-modal-summary" id="sold-modal-summary"></div>
  </div>
</div>

<!-- Menu -->
<section id="menu" class="hidden">
  <h2>Quản lý menu</h2>
  <div style="margin-bottom:10px">
    <input id="new-ten" placeholder="Tên món">
    <input id="new-gia" type="number" placeholder="Giá (VNĐ)" min="1000" max="10000000" inputmode="numeric">
    <span style="margin-left:6px;font-weight:bold;">VND</span>
    <button class="btn success" onclick="addMenu()">Thêm</button>
    <div id="menu-msg" class="msg-err"></div>
  </div>
  <table id="menu-table"></table>
  <div style="margin-top:12px">
    <input type="file" id="csv-file" accept=".csv">
    <button class="btn primary" onclick="importCSV()">Import CSV</button>
  </div>
</section>

<!-- Nhập kho -->
<section id="nhapkho" class="hidden">
  <h2>Quản lý nhập kho</h2>
  <div>
    <input id="nhap-ten" placeholder="Tên món (tự do)">
    <input type="number" id="nhap-sl" placeholder="Số lượng" min="1" max="99999" inputmode="numeric">
    <input type="number" id="nhap-gia" placeholder="Đơn giá (VNĐ)" min="100" max="10000000" inputmode="numeric">
    <span style="margin-left:6px;font-weight:bold;">VND</span>
    <button class="btn success" onclick="addNhap()">Nhập</button>
    <div id="nhap-msg" class="msg-err"></div>
  </div>
  <table id="nhap-table"></table>
</section>

<!-- Báo cáo -->
<section id="baocao" class="hidden">
  <h2>Báo cáo</h2>
  <label for="report-month" style="font-size:1.08em;">Chọn tháng:</label>
  <input type="month" id="report-month" style="font-size:1.08em;padding:6px" onchange="renderReport()">
  
  <h3>Danh sách bán hàng trong tháng</h3>
  <div id="report-sales"></div>
  
  <h3>Doanh thu &amp; Lợi nhuận (Tuần / Tháng / Năm)</h3>
  <div id="report-summary"></div>
</section>

<!-- Cài đặt -->
<section id="caidat" class="hidden">
  <h2>Cài đặt</h2>
  <button class="btn danger" onclick="clearData()">Xóa toàn bộ dữ liệu</button>
  <button class="btn secondary" onclick="exportData()">Xuất dữ liệu</button>
  <input type="file" id="import-json" accept=".json" style="margin-top:12px">
  <button class="btn primary" onclick="importData()">Nhập dữ liệu</button>
  <div style="margin-top:8px;color:#8d6e63;font-size:0.98em;">
    Hãy sao lưu dữ liệu định kỳ!<br>
    <b>Khi nhập dữ liệu sẽ ghi đè dữ liệu hiện tại.</b>
  </div>
</section>

<!-- Popup nhập số lượng bán -->
<div id="sell-popup" class="popup" tabindex="-1" onclick="popupBackdrop(event)">
  <div class="popup-content">
    <button class="close-x" onclick="closePopup()" title="Đóng">×</button>
    <h3 id="popup-name"></h3>
    <p>Giá: <span id="popup-price"></span></p>
    <input type="number" id="popup-qty" min="1" value="1" inputmode="numeric" autocomplete="off">
    <div id="popup-err" class="msg-err"></div>
    <div style="margin-top:15px">
      <button class="btn primary" onclick="confirmSell()">Xác nhận</button>
      <button class="btn danger" onclick="closePopup()">Hủy</button>
    </div>
  </div>
</div>

<!-- Menu Edit Popup -->
<div id="menu-edit-popup-back" class="popup" style="z-index:1200" tabindex="-1" onclick="closeMenuEditPopup(event)">
  <div class="menu-edit-popup" id="menu-edit-popup" style="display:none"></div>
</div>

<script>
const LS_MENU="menu",LS_SALES="sales",LS_NHAP="nhapkho";
let menu,sales,nhapkho;
// Load from storage first (ensure no data lost)
try {
  menu=JSON.parse(localStorage.getItem(LS_MENU)||"[]");
  sales=JSON.parse(localStorage.getItem(LS_SALES)||"[]");
  nhapkho=JSON.parse(localStorage.getItem(LS_NHAP)||"[]");
} catch(e) {
  menu=[];sales=[];nhapkho=[];
  localStorage.setItem(LS_MENU,"[]");
  localStorage.setItem(LS_SALES,"[]");
  localStorage.setItem(LS_NHAP,"[]");
}
let currentItem=null,lastSoldId=null;
const fmt=new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"});

// Pagination state
let menuPage = 1;
let soldModalPage = 1;

// Utility
function qs(id){return document.querySelector(id);}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function showMsg(id, msg) { qs(id).innerText=msg; }
function clearMsg(id) { qs(id).innerText=""; }
function setErrField(id, on) {
    let el = typeof id === 'string' ? qs(id) : id;
    if (!el) return;
    if (on) el.classList.add('error');
    else el.classList.remove('error');
}
function formatVND(val) {
  if(val===""||isNaN(+val)) return "";
  return (+val).toLocaleString('vi-VN') + " VND";
}
function formatOnlyVND(val) {
  if(val===""||isNaN(+val)) return "";
  return (+val).toLocaleString('vi-VN');
}
function popupBackdrop(e) {
    if (e.target.classList.contains('popup')) closePopup();
}

// Tab navigation
function openTab(id){
    document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
    qs("#"+id).classList.remove("hidden");
    document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
    qs("#tab-"+id)?.classList.add("active");
    if(id==="banhang") renderBanHang();
    if(id==="menu") renderMenu();
    if(id==="nhapkho") renderNhap();
    if(id==="baocao") renderReport();
}

// --- Bán hàng: list, search, pagination ---
function renderBanHang(){
  // Filtering
  let search = qs("#menu-search").value.trim().toLowerCase();
  let filtered = !search ? menu.slice() :
    menu.filter(m=>m.ten.toLowerCase().includes(search));
  // Dropdown for search
  let dropdown = qs("#menu-search-dropdown");
  if(search && filtered.length > 0) {
    dropdown.innerHTML = "";
    filtered.slice(0,8).forEach(m=>{
      let d = document.createElement("div");
      d.textContent = m.ten;
      d.onclick = ()=>{qs("#menu-search").value = m.ten; dropdown.style.display="none"; renderBanHang();};
      dropdown.appendChild(d);
    });
    dropdown.style.display = "block";
  } else {
    dropdown.style.display = "none";
  }
  // Pagination
  let pageSize = qs("#menu-page-size").value;
  let total = filtered.length;
  let maxPage = 1;
  if(pageSize !== "all") {
    pageSize = +pageSize;
    maxPage = Math.ceil(total/pageSize)||1;
    if(menuPage > maxPage) menuPage = maxPage;
  } else {
    pageSize = total||1;
    menuPage = 1;
    maxPage = 1;
  }
  // Render page items
  let start = (menuPage-1)*pageSize;
  let pageItems = filtered.slice(start, start+pageSize);
  let list = qs("#ban-row-list");
  list.innerHTML = "";
  if(!pageItems.length) {
    list.innerHTML = `<div style="text-align:center;color:#8d6e63;">Không có món.</div>`;
  } else {
    pageItems.forEach(m=>{
      let row = document.createElement("div");
      row.className = "menu-row-item";
      row.innerHTML = `<span class="item-name">${m.ten}</span>
        <span class="item-price">${formatOnlyVND(m.gia)} VND</span>`;
      row.onclick=()=>openPopup(m);
      list.appendChild(row);
    });
  }
  // Pagination info
  qs("#menu-page-info").textContent = `${menuPage}/${maxPage}`;
  qs("#menu-prev").disabled = (menuPage <= 1);
  qs("#menu-next").disabled = (menuPage >= maxPage || maxPage===1);
}
function changeMenuPage(d){
  menuPage += d;
  if(menuPage < 1) menuPage = 1;
  renderBanHang();
}
qs("#menu-search").addEventListener("focus", ()=>renderBanHang());
qs("#menu-search").addEventListener("blur", ()=>setTimeout(()=>qs("#menu-search-dropdown").style.display="none", 200));
qs("#menu-search").addEventListener("keydown", e=>{ if(e.key==="Enter") renderBanHang(); });

// Bán hàng: popup bán
function openPopup(item){
    currentItem=item;
    qs("#popup-name").textContent=item.ten;
    qs("#popup-price").textContent=formatOnlyVND(item.gia) + " VND";
    qs("#popup-qty").value=1;
    qs("#popup-err").innerText="";
    setTimeout(()=>{qs("#popup-qty").focus();}, 60);
    qs("#sell-popup").style.display="flex";
}
function closePopup(){qs("#sell-popup").style.display="none";}
function confirmSell(){
    let sl=+qs("#popup-qty").value;
    if(isNaN(sl)||sl<1||sl>99999){
        qs("#popup-err").innerText="Số lượng phải >=1 và ≤99999";
        setErrField("#popup-qty", 1);
        return;
    }
    setErrField("#popup-qty", 0);
    const ts=Date.now(),id="s"+ts;
    sales.push({id,ten:currentItem.ten,gia:currentItem.gia,sl,ts});
    save(LS_SALES,sales);
    lastSoldId=id; closePopup(); 
    renderBanHang();
}

// Sold Modal
function openSoldModal() {
  soldModalPage = 1;
  renderSoldModal();
  qs("#sold-modal").style.display="flex";
}
function closeSoldModal() {
  qs("#sold-modal").style.display="none";
}
function soldModalPageChange(d) {
  soldModalPage += d;
  renderSoldModal();
}
function renderSoldModal() {
  const today=new Date(); today.setHours(0,0,0,0);
  const sold=sales.filter(s=>s.ts>=today.getTime());
  let pageSize = 8;
  let total = sold.length;
  let maxPage = Math.ceil(total/pageSize)||1;
  if(soldModalPage > maxPage) soldModalPage = maxPage;
  if(soldModalPage < 1) soldModalPage = 1;
  let start = (soldModalPage-1)*pageSize;
  let pageItems = sold.slice(start, start+pageSize);

  let html = `<table class="sold-modal-table"><tr>
    <th>Món</th><th>SL</th><th>Thành tiền</th></tr>`;
  let tongSL=0, tongTien=0;
  pageItems.forEach(s=>{
    const tt=s.sl*s.gia; tongSL+=s.sl; tongTien+=tt;
    const hl=(s.id===lastSoldId)?"sold-modal-highlight":"";
    html+=`<tr class="${hl}">
      <td>${s.ten}</td>
      <td>${s.sl}</td>
      <td>${formatOnlyVND(tt)} VND</td>
    </tr>`;
  });
  if(!pageItems.length) html+=`<tr><td colspan=3><i>Chưa bán hôm nay</i></td></tr>`;
  html+=`</table>`;
  qs("#sold-modal-list").innerHTML=html;
  qs("#sold-modal-page-info").textContent=`${soldModalPage}/${maxPage}`;
  qs("#sold-modal-prev").disabled=(soldModalPage<=1);
  qs("#sold-modal-next").disabled=(soldModalPage>=maxPage||maxPage===1);

  // Tổng số lượng và tổng giá
  let totalSL = sold.reduce((a,b)=>a+b.sl,0);
  let totalTT = sold.reduce((a,b)=>a+b.sl*b.gia,0);
  qs("#sold-modal-summary").innerHTML = `<span>Tổng SL: ${totalSL}</span> <span>Tổng tiền: ${formatOnlyVND(totalTT)} VND</span>`;
}

// --- Nhập kho: editable, removable ---
function renderNhap(){
  let html="<tr><th>Món</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th><th></th></tr>";
  nhapkho.slice().reverse().forEach((n,idx)=>{
    if(n.editing) {
      html += `<tr class="nhap-table-editing">
        <td><input type="text" value="${n.ten}" id="edit-nhap-ten-${idx}" /></td>
        <td><input type="number" value="${n.sl}" id="edit-nhap-sl-${idx}" min="1" max="99999" /></td>
        <td><input type="number" value="${n.gia}" id="edit-nhap-gia-${idx}" min="100" max="10000000" /></td>
        <td colspan="2">
          <button class="btn success" onclick="saveEditNhap(${idx})">Lưu</button>
          <button class="btn danger" onclick="cancelEditNhap(${idx})">Hủy</button>
        </td>
      </tr>`;
    } else {
      html+=`<tr>
          <td>${n.ten}</td>
          <td>${n.sl}</td>
          <td>${formatOnlyVND(n.gia)} VND</td>
          <td>${formatOnlyVND(n.sl*n.gia)} VND</td>
          <td class="nhap-table-btns">
            <button class="btn primary" onclick="editNhap(${idx})">Sửa</button>
            <button class="btn danger" onclick="removeNhap(${idx})">Xóa</button>
          </td>
        </tr>`;
    }
  });
  qs("#nhap-table").innerHTML=html;
}
function addNhap(){
  const ten=qs("#nhap-ten").value.trim();
  const sl=+qs("#nhap-sl").value;
  const gia=+qs("#nhap-gia").value;
  setErrField("#nhap-ten",0); setErrField("#nhap-sl",0); setErrField("#nhap-gia",0); clearMsg("#nhap-msg");
  if(!ten){
    setErrField("#nhap-ten",1); showMsg("#nhap-msg","Tên món không được để trống!"); return;
  }
  if(isNaN(sl)||sl<1||sl>99999) {
    setErrField("#nhap-sl",1); showMsg("#nhap-msg","Số lượng 1-99999"); return;
  }
  if(isNaN(gia)||gia<100||gia>10000000) {
    setErrField("#nhap-gia",1); showMsg("#nhap-msg","Đơn giá 100-10.000.000"); return;
  }
  nhapkho.push({ten,sl,gia,ts:Date.now()});save(LS_NHAP,nhapkho);
  qs("#nhap-sl").value="";qs("#nhap-gia").value="";qs("#nhap-ten").value="";
  renderNhap();
}
function editNhap(idx) {
  let arr = nhapkho.slice().reverse();
  arr[idx].editing = true;
  nhapkho = arr.reverse();
  renderNhap();
}
function cancelEditNhap(idx) {
  let arr = nhapkho.slice().reverse();
  delete arr[idx].editing;
  nhapkho = arr.reverse();
  renderNhap();
}
function saveEditNhap(idx) {
  let arr = nhapkho.slice().reverse();
  let row = arr[idx];
  const ten = qs(`#edit-nhap-ten-${idx}`).value.trim();
  const sl = +qs(`#edit-nhap-sl-${idx}`).value;
  const gia = +qs(`#edit-nhap-gia-${idx}`).value;
  if(!ten) { alert("Tên món không được để trống!"); return; }
  if(isNaN(sl)||sl<1||sl>99999) { alert("Số lượng 1-99999"); return; }
  if(isNaN(gia)||gia<100||gia>10000000) { alert("Đơn giá 100-10.000.000"); return; }
  row.ten = ten; row.sl = sl; row.gia = gia;
  delete row.editing;
  nhapkho = arr.reverse();
  save(LS_NHAP, nhapkho);
  renderNhap();
}
function removeNhap(idx) {
  if(!confirm("Xóa dòng này?")) return;
  let arr = nhapkho.slice().reverse();
  arr.splice(idx,1);
  nhapkho = arr.reverse();
  save(LS_NHAP, nhapkho);
  renderNhap();
}

// --- Menu edit by name, popup ---
function renderMenu(){
  let html="<tr><th>Tên</th><th>Giá</th><th></th></tr>";
  menu.forEach((m,i)=>{
    html+=`<tr>
      <td>${m.ten}</td>
      <td><input type="number" value="${m.gia}" min="1000" max="10000000" oninput="this.value=formatOnlyVND(this.value.replace(/[^0-9]/g,''));" onchange="editGia(${i},this.value.replace(/[^0-9]/g,''))"><span style="margin-left:3px;font-weight:bold;">VND</span></td>
      <td>
        <button class="btn primary" onclick="openMenuEditPopup(${i})">Sửa</button>
        <button class="btn danger" onclick="delMenu(${i})">X</button>
      </td>
    </tr>`;
  });
  qs("#menu-table").innerHTML=html;
}
function addMenu(){
  const ten=qs("#new-ten").value.trim();
  const gia=+qs("#new-gia").value;
  setErrField("#new-ten",0); setErrField("#new-gia",0); clearMsg("#menu-msg");
  if(!ten) { setErrField("#new-ten",1); showMsg("#menu-msg","Tên món không được để trống."); return; }
  if(menu.find(m=>m.ten.toLowerCase()===ten.toLowerCase())) {
    setErrField("#new-ten",1); showMsg("#menu-msg","Tên món đã tồn tại."); return;
  }
  if(isNaN(gia)||gia<1000||gia>10000000){
    setErrField("#new-gia",1); showMsg("#menu-msg","Giá từ 1.000 đến 10.000.000"); return;
  }
  menu.push({ten,gia});
  save(LS_MENU,menu);
  qs("#new-ten").value="";qs("#new-gia").value="";
  renderMenu(); renderBanHang();
}
function editGia(i,val){
    val=+val.replace(/[^0-9]/g,'');
    if(isNaN(val) || val<1000 || val>10000000){
        alert("Giá từ 1.000 đến 10.000.000"); renderMenu(); return;
    }
    menu[i].gia=val;save(LS_MENU,menu); renderBanHang();
}
function delMenu(i){
    if(!confirm("Xóa món này?")) return;
    menu.splice(i,1);save(LS_MENU,menu);renderMenu();renderBanHang();
}
function importCSV(){
    const file=qs("#csv-file").files[0];if(!file)return;
    let count=0;
    const r=new FileReader();r.onload=e=>{
        const lines=e.target.result.split(/\r?\n/);
        lines.forEach(l=>{
            const p=l.split(",");
            if(p.length>=2){
                const ten=p[0].trim();
                const gia=+p[1];
                if(ten && gia>999 && !menu.find(m=>m.ten.toLowerCase()===ten.toLowerCase())){
                    menu.push({ten,gia}); count++;
                }
            }
        });
        save(LS_MENU,menu);renderMenu();renderBanHang();
        alert(count?`${count} món đã được thêm!`:"Không có món hợp lệ mới!");
    };r.readAsText(file);
}
function openMenuEditPopup(i){
  let m = menu[i];
  let popup = qs("#menu-edit-popup");
  popup.innerHTML = `
    <h3>Sửa món</h3>
    <div class="msg-err" id="menu-edit-msg"></div>
    <input id="edit-ten" value="${m.ten}" placeholder="Tên món">
    <input id="edit-gia" type="number" value="${m.gia}" min="1000" max="10000000" inputmode="numeric" placeholder="Giá (VNĐ)">
    <span style="font-weight:bold;">VND</span>
    <div style="margin-top:10px">
      <button class="btn primary" onclick="editMenuItem(${i})">Lưu</button>
      <button class="btn danger" onclick="closeMenuEditPopup()">Hủy</button>
    </div>`;
  popup.style.display = "block";
  qs("#menu-edit-popup-back").style.display="flex";
}
function closeMenuEditPopup(e){
  if(!e || e.target.classList.contains("popup"))
    qs("#menu-edit-popup-back").style.display="none", qs("#menu-edit-popup").style.display="none";
}
function editMenuItem(i){
  let ten = qs("#edit-ten").value.trim();
  let gia = +qs("#edit-gia").value;
  setErrField("#edit-ten",0); setErrField("#edit-gia",0); clearMsg("#menu-edit-msg");
  if(!ten) { setErrField("#edit-ten",1); showMsg("#menu-edit-msg","Tên món không để trống."); return; }
  if(menu.some((m,idx)=>idx!==i && m.ten.toLowerCase()===ten.toLowerCase())){
    setErrField("#edit-ten",1); showMsg("#menu-edit-msg","Tên món đã tồn tại."); return;
  }
  if(isNaN(gia)||gia<1000||gia>10000000){
    setErrField("#edit-gia",1); showMsg("#menu-edit-msg","Giá từ 1.000 đến 10.000.000"); return;
  }
  menu[i].ten = ten; menu[i].gia = gia; save(LS_MENU, menu);
  closeMenuEditPopup(); renderMenu(); renderBanHang();
}

// Báo cáo
function renderReport(){
    const monthInput=qs("#report-month").value;
    let monthStart,monthEnd;
    if(monthInput){
        const [y,m]=monthInput.split("-").map(Number);
        monthStart=new Date(y,m-1,1);monthEnd=new Date(y,m,1);
    }else{
        const today=new Date();monthStart=new Date(today.getFullYear(),today.getMonth(),1);
        monthEnd=new Date(today.getFullYear(),today.getMonth()+1,1);
        qs("#report-month").value=today.toISOString().slice(0,7);
    }
    const soldMonth=sales.filter(s=>s.ts>=monthStart.getTime()&&s.ts<monthEnd.getTime());
    let htmlSales="<table><tr><th>Món</th><th>SL</th><th>Thành tiền</th></tr>";
    if(!soldMonth.length) htmlSales+="<tr><td colspan=3><i>Không có dữ liệu</i></td></tr>";
    else soldMonth.forEach(s=>htmlSales+=`<tr><td>${s.ten}</td><td>${s.sl}</td><td>${formatOnlyVND(s.sl*s.gia)} VND</td></tr>`);
    htmlSales+="</table>";qs("#report-sales").innerHTML=htmlSales;

    const today=new Date();today.setHours(0,0,0,0);
    const weekStart=new Date(today);weekStart.setDate(weekStart.getDate()-weekStart.getDay());
    const yearStart=new Date(today.getFullYear(),0,1);
    function sumSales(fn){return sales.filter(fn).reduce((a,b)=>a+b.sl*b.gia,0);}
    function sumNhap(fn){return nhapkho.filter(fn).reduce((a,b)=>a+b.sl*b.gia,0);}
    function numClass(num) { return num>=0?'highlight-positive':'highlight-negative'; }
    const doanhThuTuan = sumSales(s=>s.ts>=weekStart.getTime());
    const doanhThuThang = sumSales(s=>s.ts>=monthStart.getTime() && s.ts<monthEnd.getTime());
    const doanhThuNam = sumSales(s=>s.ts>=yearStart.getTime());
    const loiNhuanTuan = doanhThuTuan-sumNhap(n=>n.ts>=weekStart.getTime());
    const loiNhuanThang = doanhThuThang-sumNhap(n=>n.ts>=monthStart.getTime() && n.ts<monthEnd.getTime());
    const loiNhuanNam = doanhThuNam-sumNhap(n=>n.ts>=yearStart.getTime());
    const htmlSummary=`<table>
        <tr><th>Khoảng</th><th>Doanh thu</th><th>Chi phí</th><th>Lợi nhuận</th></tr>
        <tr><td>Tuần</td>
            <td class="${numClass(doanhThuTuan)}">${formatOnlyVND(doanhThuTuan)} VND</td>
            <td>${formatOnlyVND(sumNhap(n=>n.ts>=weekStart.getTime()))} VND</td>
            <td class="${numClass(loiNhuanTuan)}">${formatOnlyVND(loiNhuanTuan)} VND</td></tr>
        <tr><td>Tháng (${qs("#report-month").value})</td>
            <td class="${numClass(doanhThuThang)}">${formatOnlyVND(doanhThuThang)} VND</td>
            <td>${formatOnlyVND(sumNhap(n=>n.ts>=monthStart.getTime() && n.ts<monthEnd.getTime()))} VND</td>
            <td class="${numClass(loiNhuanThang)}">${formatOnlyVND(loiNhuanThang)} VND</td></tr>
        <tr><td>Năm</td>
            <td class="${numClass(doanhThuNam)}">${formatOnlyVND(doanhThuNam)} VND</td>
            <td>${formatOnlyVND(sumNhap(n=>n.ts>=yearStart.getTime()))} VND</td>
            <td class="${numClass(loiNhuanNam)}">${formatOnlyVND(loiNhuanNam)} VND</td></tr>
    </table>`;
    qs("#report-summary").innerHTML=htmlSummary;
}

// Cài đặt + Import/Export
function clearData(){
    if(confirm("Xóa toàn bộ dữ liệu?")){
        localStorage.clear();menu=[];sales=[];nhapkho=[];
        renderMenu();renderNhap();renderBanHang();alert("Đã xóa dữ liệu!");
    }
}
function exportData(){
    const blob = new Blob([JSON.stringify({
        menu,sales,nhapkho
    },null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download="tram-ca-phe-data-"+new Date().toISOString().slice(0,10)+".json";
    a.click();
}
function importData(){
    const file=qs("#import-json").files[0];
    if(!file) return alert("Chọn file dữ liệu .json!");
    if(!confirm("Nhập dữ liệu mới sẽ ghi đè dữ liệu cũ. Tiếp tục?")) return;
    const r=new FileReader();
    r.onload=e=>{
        try {
            const data=JSON.parse(e.target.result);
            if(!Array.isArray(data.menu)||!Array.isArray(data.sales)||!Array.isArray(data.nhapkho))
                throw "Sai định dạng";
            menu=data.menu;
            sales=data.sales;
            nhapkho=data.nhapkho;
            save(LS_MENU,menu); save(LS_SALES,sales); save(LS_NHAP,nhapkho);
            renderMenu();renderNhap();renderBanHang();
            alert("Đã nhập dữ liệu!");
        }catch(e){ alert("Dữ liệu nhập không hợp lệ!"); }
    };r.readAsText(file);
}

// Auto-format VND for price fields
function addVNDInputFormat(id) {
  let el = qs(id);
  if(!el) return;
  el.addEventListener("input",function(){
     this.value=this.value.replace(/[^0-9]/g,"");
     if(this.value) this.value = (+this.value).toLocaleString('vi-VN');
  });
}
// Apply to price input fields
setTimeout(()=>{
  addVNDInputFormat("#new-gia");
  addVNDInputFormat("#nhap-gia");
}, 300);

// Khởi tạo tab đầu tiên
openTab("banhang");
// Auto focus on popups for iOS Safari (patch)
document.addEventListener("touchstart",()=>{},true);
</script>
</body>
</html>
