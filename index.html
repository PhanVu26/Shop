<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TRẠM CÀ PHÊ</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f7f3ee;margin:0;color:#2b2a28;font-size:18px}
  header{background:#6f4e37;color:#fff;padding:12px;position:sticky;top:0}
  header h1{margin:0;font-size:26px}
  .tabs{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .tab-btn{font-size:18px;padding:10px 18px;border:none;border-radius:8px;cursor:pointer}
  .tab-btn.active{background:#2b2a28;color:#fff}
  .tab-btn:not(.active){background:#fff;color:#6f4e37}
  main{padding:18px}
  .hidden{display:none}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
  .card{background:#fff;border:1px solid #ddd;padding:14px;border-radius:10px;font-size:18px}
  h3{margin-top:0;font-size:20px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px}
  input[type=number],input[type=text]{font-size:18px;padding:8px;border:1px solid #ccc;border-radius:6px}
  .btn{font-size:18px;padding:8px 14px;border:none;border-radius:8px;cursor:pointer}
  .btn.primary{background:#6f4e37;color:#fff}
  .btn.danger{background:#b71c1c;color:#fff}
  .btn.success{background:#2e7d32;color:#fff}
  .btn.info{background:#0277bd;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:14px;font-size:18px}
  th,td{border:1px solid #ccc;padding:8px;text-align:left}
  th{background:#eee}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <h1>☕ TRẠM CÀ PHÊ</h1>
  <div class="tabs">
    <button class="tab-btn active" data-tab="banhang">Bán hàng</button>
    <button class="tab-btn" data-tab="menu">Quản lý menu</button>
    <button class="tab-btn" data-tab="nhapkho">Nhập kho</button>
    <button class="tab-btn" data-tab="baocao">Báo cáo</button>
    <button class="tab-btn" data-tab="caidat">Cài đặt</button>
  </div>
</header>

<main>
  <!-- BÁN HÀNG -->
  <section id="banhang">
    <h3>Danh sách món</h3>
    <div id="ban-grid" class="grid"></div>
    <h3>Hóa đơn tạm</h3>
    <div id="ban-table"></div>
  </section>

  <!-- MENU -->
  <section id="menu" class="hidden">
    <h3>Thêm / sửa món</h3>
    <div class="row">
      <input id="menu-ten" type="text" placeholder="Tên món" />
      <input id="menu-gia" type="number" min="1000" step="1000" placeholder="Giá (VNĐ)" />
      <button id="menu-save" class="btn primary">Lưu</button>
      <button id="menu-cancel" class="btn danger hidden">Hủy</button>
    </div>
    <h3>Danh sách menu</h3>
    <div id="menu-list"></div>
  </section>

  <!-- NHẬP KHO -->
  <section id="nhapkho" class="hidden">
    <h3>Nhập kho</h3>
    <div class="row">
      <input id="kho-ten" type="text" placeholder="Tên hàng" />
      <input id="kho-sl" type="number" min="1" placeholder="Số lượng" />
      <input id="kho-dg" type="number" min="1" placeholder="Đơn giá" />
      <button id="kho-save" class="btn primary">Thêm</button>
    </div>
    <h3>Danh sách nhập kho</h3>
    <div id="kho-list"></div>
  </section>

  <!-- BÁO CÁO -->
  <section id="baocao" class="hidden">
    <h3>Báo cáo doanh thu & lợi nhuận</h3>
    <div class="row">
      <label>Chọn kỳ:</label>
      <select id="ky" style="font-size:18px;padding:6px">
        <option value="day">Hôm nay</option>
        <option value="week">Tuần này</option>
        <option value="month">Tháng này</option>
        <option value="year">Năm nay</option>
      </select>
      <button id="btn-export" class="btn success">Xuất Excel</button>
    </div>
    <div id="report"></div>
  </section>

  <!-- CÀI ĐẶT -->
  <section id="caidat" class="hidden">
    <h3>Dữ liệu</h3>
    <button id="btn-clear" class="btn danger">Xóa toàn bộ dữ liệu</button>
  </section>
</main>

<script>
const LS_MENU="cf_menu", LS_SALES="cf_sales", LS_KHO="cf_kho";
const fmt=new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",maximumFractionDigits:0});
const qs=s=>document.querySelector(s); const qsa=s=>document.querySelectorAll(s);

function load(k){try{return JSON.parse(localStorage.getItem(k))||[]}catch{return[]}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
let menu=load(LS_MENU), sales=load(LS_SALES), kho=load(LS_KHO);
let draft=[]; // hóa đơn tạm

// Tabs
qsa(".tab-btn").forEach(b=>b.onclick=()=>{
  qsa(".tab-btn").forEach(x=>x.classList.remove("active")); b.classList.add("active");
  qsa("main section").forEach(s=>s.classList.add("hidden"));
  qs("#"+b.dataset.tab).classList.remove("hidden");
  if(b.dataset.tab==="banhang") renderBanHang();
  if(b.dataset.tab==="menu") renderMenu();
  if(b.dataset.tab==="nhapkho") renderKho();
  if(b.dataset.tab==="baocao") renderReport();
});

// Quản lý Menu
function renderMenu(){
  const list=qs("#menu-list"); list.innerHTML="";
  menu.forEach((m,i)=>{
    const div=document.createElement("div");
    div.className="row"; 
    div.innerHTML=`<div style="flex:1">${m.ten} - ${fmt.format(m.gia)}</div>
      <button class="btn danger">Xóa</button>`;
    div.querySelector(".danger").onclick=()=>{
      if(confirm("Xóa món này?")){menu.splice(i,1);save(LS_MENU,menu);renderMenu();renderBanHang();}
    };
    list.appendChild(div);
  })
}
qs("#menu-save").onclick=()=>{
  const ten=qs("#menu-ten").value.trim(), gia=+qs("#menu-gia").value;
  if(!ten||isNaN(gia)||gia<1000){alert("Nhập tên và giá hợp lệ");return}
  menu.push({ten,gia});
  save(LS_MENU,menu);
  qs("#menu-ten").value="";qs("#menu-gia").value="";
  renderMenu();renderBanHang();
}

// Nhập kho
function renderKho(){
  const list=qs("#kho-list"); list.innerHTML="";
  if(!kho.length){list.innerHTML="<i>Chưa có dữ liệu</i>";return}
  let tong=0;
  let html="<table><tr><th>Tên hàng</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th><th></th></tr>";
  kho.forEach((m,i)=>{
    const tt=m.sl*m.dg; tong+=tt;
    html+=`<tr><td>${m.ten}</td><td>${m.sl}</td><td>${fmt.format(m.dg)}</td><td>${fmt.format(tt)}</td>
    <td><button class="btn danger" onclick="delKho(${i})">Xóa</button></td></tr>`;
  });
  html+=`<tr><th colspan=3>Tổng chi phí</th><th>${fmt.format(tong)}</th><th></th></tr></table>`;
  list.innerHTML=html;
}
qs("#kho-save").onclick=()=>{
  const ten=qs("#kho-ten").value.trim(), sl=+qs("#kho-sl").value, dg=+qs("#kho-dg").value;
  if(!ten||isNaN(sl)||sl<1||isNaN(dg)||dg<1){alert("Nhập dữ liệu hợp lệ");return}
  kho.push({ten,sl,dg,ts:Date.now()});
  save(LS_KHO,kho);
  qs("#kho-ten").value="";qs("#kho-sl").value="";qs("#kho-dg").value="";
  renderKho();
}
function delKho(i){ if(confirm("Xóa phiếu nhập?")){kho.splice(i,1);save(LS_KHO,kho);renderKho();} }

// Bán hàng
function renderBanHang(){
  const grid=qs("#ban-grid"); grid.innerHTML="";
  menu.forEach(m=>{
    const c=document.createElement("div"); c.className="card";
    c.innerHTML=`<b>${m.ten}</b><br>${fmt.format(m.gia)}
      <div class="row"><input type="number" min="1" step="1" value="1" style="width:90px">
      <button class="btn success">Chọn</button></div>`;
    const inp=c.querySelector("input");
    c.querySelector("button").onclick=()=>{
      const sl=+inp.value;
      if(isNaN(sl)||sl<1){alert("Số lượng không hợp lệ");return;}
      draft.push({ten:m.ten,gia:m.gia,sl});
      renderHoaDon();
    };
    grid.appendChild(c);
  });
  renderHoaDon();
}
function renderHoaDon(){
  if(!draft.length){qs("#ban-table").innerHTML="<i>Chưa có món trong hóa đơn</i>";return}
  let tong=0, html="<table><tr><th>Món</th><th>SL</th><th>Thành tiền</th><th></th></tr>";
  draft.forEach((s,idx)=>{
    const t=s.sl*s.gia; tong+=t;
    html+=`<tr><td>${s.ten}</td><td>${s.sl}</td><td>${fmt.format(t)}</td>
      <td><button class="btn danger" onclick="rollbackDraft(${idx})">Hủy</button></td></tr>`;
  });
  html+=`<tr><th colspan=2>Tổng</th><th>${fmt.format(tong)}</th><th></th></tr></table>`;
  html+=`<div style="margin-top:12px"><button class="btn primary" onclick="finalizeOrder()">Tổng kết đơn</button></div>`;
  qs("#ban-table").innerHTML=html;
}
function rollbackDraft(index){ draft.splice(index,1); renderHoaDon(); }
function finalizeOrder(){
  if(!draft.length)return;
  if(!confirm("Xác nhận tổng kết đơn này?"))return;
  const ts=Date.now();
  draft.forEach(d=>{sales.push({...d,ts});});
  save(LS_SALES,sales);
  draft=[]; renderHoaDon();
  alert("Đơn đã được ghi vào báo cáo!");
}

// Báo cáo
function getRange(ky){
  let start=new Date(),end=new Date();
  if(ky==="day"){start.setHours(0,0,0,0); end.setHours(23,59,59,999);}
  if(ky==="week"){const d=start.getDay();start.setDate(start.getDate()-d+1);start.setHours(0,0,0,0);end=new Date(start);end.setDate(start.getDate()+6);end.setHours(23,59,59,999);}
  if(ky==="month"){start=new Date(start.getFullYear(),start.getMonth(),1);end=new Date(start.getFullYear(),start.getMonth()+1,0);}
  if(ky==="year"){start=new Date(start.getFullYear(),0,1);end=new Date(start.getFullYear(),11,31);}
  return {start,end};
}
function renderReport(){
  const ky=qs("#ky").value; const {start,end}=getRange(ky);
  const dsales=sales.filter(s=>s.ts>=start.getTime() && s.ts<=end.getTime());
  const dkho=kho.filter(k=>k.ts>=start.getTime() && k.ts<=end.getTime());

  // Doanh thu
  let tongDT=0; const agg={};
  dsales.forEach(s=>{if(!agg[s.ten])agg[s.ten]={sl:0,dt:0};agg[s.ten].sl+=s.sl;agg[s.ten].dt+=s.sl*s.gia;})
  let html="<h4>Doanh thu bán hàng</h4><table><tr><th>Món</th><th>SL</th><th>Doanh thu</th></tr>";
  Object.entries(agg).forEach(([ten,v])=>{tongDT+=v.dt;html+=`<tr><td>${ten}</td><td>${v.sl}</td><td>${fmt.format(v.dt)}</td></tr>`});
  html+=`<tr><th colspan=2>Tổng doanh thu</th><th>${fmt.format(tongDT)}</th></tr></table>`;

  // Chi phí
  let tongCP=0;
  if(dkho.length){
    html+=`<h4>Chi phí nhập kho</h4><table><tr><th>Hàng</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th></tr>`;
    dkho.forEach(k=>{const tt=k.sl*k.dg; tongCP+=tt; html+=`<tr><td>${k.ten}</td><td>${k.sl}</td><td>${fmt.format(k.dg)}</td><td>${fmt.format(tt)}</td></tr>`});
    html+=`<tr><th colspan=3>Tổng chi phí</th><th>${fmt.format(tongCP)}</th></tr></table>`;
  }

  // Lợi nhuận
  html+=`<h4>Kết quả</h4><p>Doanh thu: ${fmt.format(tongDT)}<br>Chi phí: ${fmt.format(tongCP)}<br><b>Lợi nhuận: ${fmt.format(tongDT-tongCP)}</b></p>`;

  qs("#report").innerHTML=html;
}
qs("#ky").onchange=renderReport;

// Xuất Excel
qs("#btn-export").onclick=()=>{
  const ky=qs("#ky").value; const {start,end}=getRange(ky);
  const dsales=sales.filter(s=>s.ts>=start.getTime() && s.ts<=end.getTime());
  const dkho=kho.filter(k=>k.ts>=start.getTime() && k.ts<=end.getTime());
  const rows=[["Món","SL","Doanh thu"]];
  let tongDT=0, agg={};
  dsales.forEach(s=>{if(!agg[s.ten])agg[s.ten]={sl:0,dt:0};agg[s.ten].sl+=s.sl;agg[s.ten].dt+=s.sl*s.gia;})
  Object.entries(agg).forEach(([ten,v])=>{rows.push([ten,v.sl,v.dt]);tongDT+=v.dt;});
  rows.push(["Tổng doanh thu","",tongDT]);
  rows.push([]);
  rows.push(["Chi phí"]);
  rows.push(["Hàng","SL","Đơn giá","Thành tiền"]);
  let tongCP=0; dkho.forEach(k=>{const tt=k.sl*k.dg;tongCP+=tt;rows.push([k.ten,k.sl,k.dg,tt]);});
  rows.push(["Tổng chi phí","","",tongCP]);
  rows.push([]);
  rows.push(["Lợi nhuận",tongDT-tongCP]);
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"BaoCao");
  XLSX.writeFile(wb,`BaoCao_${ky}.xlsx`);
};

// Cài đặt
qs("#btn-clear").onclick=()=>{if(confirm("Xóa toàn bộ dữ liệu?")){localStorage.clear();menu=[];sales=[];kho=[];draft=[];renderBanHang();renderMenu();renderKho();renderReport();}}

// Khởi tạo
renderBanHang(); renderMenu(); renderKho(); renderReport();
</script>
</body>
</html>
