<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>TR·∫†M C√Ä PH√ä</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Helvetica Neue", sans-serif; margin:0;background:#f8f5f2;color:#2b2a28}
  header{background:#6f4e37;color:#fff;text-align:center;padding:14px 10px;font-size:28px;font-weight:700}
  nav{display:flex;justify-content:center;gap:6px;flex-wrap:wrap;background:#d7ccc8;padding:8px}
  nav button{padding:12px 18px;font-size:18px;border:none;border-radius:10px;background:#fff;color:#6f4e37}
  nav button.active{background:#a1887f;color:#fff}
  section{padding:14px}
  .hidden{display:none}

  /* Buttons & inputs big for iPhone */
  .btn{padding:12px 22px;font-size:20px;border:none;border-radius:10px;cursor:pointer}
  .btn.primary{background:#6f4e37;color:#fff}
  .btn.success{background:#2e7d32;color:#fff}
  .btn.danger{background:#c62828;color:#fff}
  input[type="text"],input[type="number"],input[type="month"],select{font-size:20px;padding:10px;border:1px solid #c7c7c7;border-radius:10px}

  table{border-collapse:collapse;width:100%;margin-top:10px}
  th,td{border:1px solid #bdbdbd;padding:10px;font-size:20px;text-align:center}
  th{background:#efeae6}

  /* Menu b√°n h√†ng: scroll ngang */
  .menu-scroll{display:flex;overflow-x:auto;gap:12px;padding:4px}
  .menu-item{flex:0 0 auto;padding:18px 20px;font-size:22px;border:2px solid #6f4e37;border-radius:12px;background:#fff;min-width:160px;text-align:center;cursor:pointer;user-select:none}
  .menu-item:active{transform:scale(0.98)}
  .menu-item:hover{background:#f0e6dd}

  /* Sold list */
  #sold-list{margin-top:12px}
  .highlight{background:#fff3cd!important}

  /* Popup */
  .popup{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
  .popup-content{background:#fff;padding:22px;border-radius:14px;width:92%;max-width:380px;text-align:center;font-size:22px;box-shadow:0 10px 30px rgba(0,0,0,0.25)}
  .popup-content input{font-size:26px;padding:10px;margin:14px 0;width:100%;text-align:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
</style>
</head>
<body>
<header>TR·∫†M C√Ä PH√ä</header>

<nav>
  <button onclick="showTab('menu')">Qu·∫£n l√Ω Menu</button>
  <button onclick="showTab('banhang')">B√°n h√†ng</button>
  <button onclick="showTab('nhapkho')">Nh·∫≠p kho</button>
  <button onclick="showTab('baocao')">B√°o c√°o</button>
</nav>

<!-- Qu·∫£n l√Ω Menu -->
<section id="menu" class="hidden">
  <h3>Th√™m / s·ª≠a m√≥n</h3>
  <div class="row">
    <input id="menu-ten" type="text" placeholder="T√™n m√≥n (VD: C√† ph√™ s·ªØa)" />
    <input id="menu-gia" type="number" min="1000" step="500" placeholder="Gi√° (VNƒê)" />
    <button id="menu-save" class="btn primary">L∆∞u</button>
    <button id="menu-cancel" class="btn danger hidden">H·ªßy</button>
  </div>
  <div class="row">
    <input id="menu-file" type="file" accept=".csv" style="display:none" />
    <button id="menu-import" class="btn success">Import CSV</button>
    <button onclick="exportMenuExcel()" class="btn">Export Excel</button>
  </div>
  <h3>Danh s√°ch menu</h3>
  <div id="menu-list"></div>
</section>

<!-- B√°n h√†ng -->
<section id="banhang" class="hidden">
  <h3>Ch·ªçn m√≥n ƒë·ªÉ b√°n</h3>
  <div class="menu-scroll" id="ban-grid"></div>

  <h3>üì¶ ƒê√£ b√°n trong ng√†y</h3>
  <div id="sold-list"></div>
</section>

<!-- Popup nh·∫≠p s·ªë l∆∞·ª£ng -->
<div id="sell-popup" class="popup" onclick="popupBackdropClick(event)">
  <div class="popup-content">
    <h3 id="popup-name"></h3>
    <p>Gi√°: <span id="popup-price"></span></p>
    <input type="number" id="popup-qty" min="1" value="1" inputmode="numeric" />
    <div class="row" style="justify-content:center">
      <button class="btn primary" onclick="confirmSell()">X√°c nh·∫≠n</button>
      <button class="btn danger" onclick="closePopup()">H·ªßy</button>
    </div>
  </div>
</div>

<!-- Nh·∫≠p kho -->
<section id="nhapkho" class="hidden">
  <h3>Nh·∫≠p h√†ng</h3>
  <div class="row">
    <input id="nk-ten" type="text" placeholder="T√™n nguy√™n li·ªáu" />
    <input id="nk-sl" type="number" min="1" step="1" placeholder="S·ªë l∆∞·ª£ng" />
    <input id="nk-gia" type="number" min="500" step="100" placeholder="ƒê∆°n gi√° (VNƒê)" />
    <button onclick="addNhapKho()" class="btn primary">Th√™m</button>
  </div>
  <h3>Danh s√°ch nh·∫≠p kho</h3>
  <div id="nk-list"></div>
</section>

<!-- B√°o c√°o -->
<section id="baocao" class="hidden">
  <h3>B√°o c√°o b√°n h√†ng</h3>
  <div class="row">
    <label for="report-month" style="font-size:20px">Ch·ªçn th√°ng:</label>
    <input type="month" id="report-month" onchange="renderReport()">
  </div>

  <h3>Danh s√°ch b√°n h√†ng trong th√°ng</h3>
  <div id="report-sales"></div>

  <h3>Doanh thu & L·ª£i nhu·∫≠n (Tu·∫ßn / Th√°ng / NƒÉm)</h3>
  <div id="report-summary"></div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
/* ===== Storage & helpers ===== */
const LS_MENU="tram_menu",LS_SALES="tram_sales",LS_NHAP="tram_nhap";
let menu=load(LS_MENU,[]),sales=load(LS_SALES,[]),nhapkho=load(LS_NHAP,[]);
const fmt=new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",maximumFractionDigits:0});
const qs=s=>document.querySelector(s);
function load(k,d){try{return JSON.parse(localStorage.getItem(k)) ?? d}catch{return d}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function nowStartOfDay(){const d=new Date();d.setHours(0,0,0,0);return d.getTime()}

function showTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  qs("#"+id).classList.remove("hidden");
  // add active class to the clicked button if available
  if(event && event.target && event.target.tagName==="BUTTON") event.target.classList.add("active");
  if(id==="menu") renderMenu();
  if(id==="banhang") renderBanHang();
  if(id==="nhapkho") renderNhapKho();
  if(id==="baocao") renderReport();
}

/* ===== MENU ===== */
function renderMenu(){
  const list=qs("#menu-list"); list.innerHTML="";
  if(!menu.length){list.innerHTML="<i>Ch∆∞a c√≥ m√≥n trong menu</i>";return}
  menu.forEach((m,i)=>{
    const d=document.createElement("div");
    d.className="row";
    d.style.justifyContent="space-between";
    d.innerHTML=`<div style="font-size:20px"><b>${m.ten}</b> - ${fmt.format(m.gia)}</div>
      <div class="row">
        <button class="btn" onclick="editMenu(${i})">S·ª≠a</button>
        <button class="btn danger" onclick="delMenu(${i})">X√≥a</button>
      </div>`;
    list.appendChild(d);
  });
}
qs("#menu-save").onclick=()=>{
  const ten=qs("#menu-ten").value.trim(), gia=+qs("#menu-gia").value;
  if(!ten || isNaN(gia) || gia<1000){alert("Vui l√≤ng nh·∫≠p t√™n v√† gi√° h·ª£p l·ªá (>= 1.000ƒë)");return}
  const idx=qs("#menu-save").dataset.edit;
  if(idx!==undefined){menu[+idx].ten=ten;menu[+idx].gia=gia;delete qs("#menu-save").dataset.edit}
  else menu.push({ten,gia});
  save(LS_MENU,menu);
  qs("#menu-ten").value=""; qs("#menu-gia").value="";
  qs("#menu-cancel").classList.add("hidden");
  renderMenu(); renderBanHang();
};
function editMenu(i){
  qs("#menu-ten").value=menu[i].ten;
  qs("#menu-gia").value=menu[i].gia;
  qs("#menu-save").dataset.edit=i;
  qs("#menu-cancel").classList.remove("hidden");
}
qs("#menu-cancel").onclick=()=>{
  delete qs("#menu-save").dataset.edit;
  qs("#menu-ten").value=""; qs("#menu-gia").value="";
  qs("#menu-cancel").classList.add("hidden");
};
function delMenu(i){
  if(confirm("X√≥a m√≥n n√†y kh·ªèi menu?")){
    menu.splice(i,1); save(LS_MENU,menu);
    renderMenu(); renderBanHang();
  }
}
qs("#menu-import").onclick=()=>qs("#menu-file").click();
qs("#menu-file").onchange=e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const lines=ev.target.result.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    let added=0;
    lines.forEach(l=>{
      const [ten,giaStr]=l.split(",");
      const gia=+((giaStr||"").trim());
      if(ten && !isNaN(gia) && gia>=1000){menu.push({ten:ten.trim(),gia}); added++;}
    });
    if(added===0) alert("Kh√¥ng c√≥ d√≤ng h·ª£p l·ªá (ƒë·ªãnh d·∫°ng: T√™n,Gi√°)");
    save(LS_MENU,menu); renderMenu(); renderBanHang();
  };
  reader.readAsText(file,"UTF-8");
  e.target.value="";
};
function exportMenuExcel(){
  if(!menu.length){alert("Menu tr·ªëng!");return}
  const ws=XLSX.utils.json_to_sheet(menu);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Menu");
  XLSX.writeFile(wb,"Menu_TraÃõmCaPhe.xlsx");
}

/* ===== B√ÅN H√ÄNG ===== */
let currentItem=null, lastSoldId=null;

function renderBanHang(){
  const grid=qs("#ban-grid"); grid.innerHTML="";
  if(!menu.length){grid.innerHTML="<i>Ch∆∞a c√≥ m√≥n trong menu</i>";return}
  menu.forEach(m=>{
    const div=document.createElement("div");
    div.className="menu-item";
    div.textContent=m.ten;
    div.onclick=()=>openPopup(m);
    grid.appendChild(div);
  });
  renderSoldToday();
}

function popupBackdropClick(e){ if(e.target.id==="sell-popup") closePopup(); }
function openPopup(item){
  currentItem=item;
  qs("#popup-name").textContent=item.ten;
  qs("#popup-price").textContent=fmt.format(item.gia);
  const qty=qs("#popup-qty");
  qty.value=1; qty.focus(); qty.select();
  qs("#sell-popup").style.display="flex";
}
function closePopup(){ qs("#sell-popup").style.display="none"; }

function confirmSell(){
  const sl=+qs("#popup-qty").value;
  if(isNaN(sl) || sl<1){alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá");return}
  const ts=Date.now(), id="s"+ts;
  sales.push({id,ten:currentItem.ten,gia:currentItem.gia,sl,ts});
  save(LS_SALES,sales);
  lastSoldId=id;
  closePopup();
  renderSoldToday();
}

/* Danh s√°ch ƒë√£ b√°n trong ng√†y ‚Äì s·ª≠a/x√≥a theo ID an to√†n */
function getTodaySales(){
  const start=nowStartOfDay();
  return sales.filter(s=>s.ts>=start);
}
function renderSoldToday(){
  const list=qs("#sold-list");
  const todaySales=getTodaySales();
  if(!todaySales.length){list.innerHTML="<i>Ch∆∞a b√°n h√¥m nay</i>";return}
  let tong=0;
  let html=`<table>
    <tr><th>M√≥n</th><th>SL</th><th>Th√†nh ti·ªÅn</th><th></th></tr>`;
  todaySales.forEach(s=>{
    const tt=s.sl*s.gia; tong+=tt;
    const hl=(s.id===lastSoldId)?"highlight":"";
    html+=`<tr class="${hl}">
      <td>${s.ten}</td>
      <td>
        <input type="number" min="1" step="1" value="${s.sl}" style="font-size:20px;width:80px"
               onchange="editSoldById('${s.id}', this.value)">
      </td>
      <td>${fmt.format(tt)}</td>
      <td><button class="btn danger" onclick="removeSoldById('${s.id}')">X</button></td>
    </tr>`;
  });
  html+=`<tr><th colspan="2">T·ªïng</th><th>${fmt.format(tong)}</th><th></th></tr></table>`;
  list.innerHTML=html;
}
function findSaleIndexById(id){ return sales.findIndex(x=>x.id===id); }
function editSoldById(id,val){
  const qty=+val;
  if(isNaN(qty)||qty<1){alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá"); renderSoldToday(); return;}
  const i=findSaleIndexById(id);
  if(i>-1){ sales[i].sl=qty; save(LS_SALES,sales); renderSoldToday(); }
}
function removeSoldById(id){
  if(!confirm("X√≥a m·ª•c ƒë√£ b√°n n√†y?")) return;
  const i=findSaleIndexById(id);
  if(i>-1){ sales.splice(i,1); save(LS_SALES,sales); renderSoldToday(); }
}

/* ===== NH·∫¨P KHO ===== */
function addNhapKho(){
  const ten=qs("#nk-ten").value.trim();
  const sl=+qs("#nk-sl").value;
  const gia=+qs("#nk-gia").value;
  if(!ten || isNaN(sl)||sl<1 || isNaN(gia)||gia<500){
    alert("Vui l√≤ng nh·∫≠p t√™n, s·ªë l∆∞·ª£ng (>=1) v√† ƒë∆°n gi√° (>=500ƒë)"); return;
  }
  nhapkho.push({ten,sl,gia,ts:Date.now()});
  save(LS_NHAP,nhapkho);
  qs("#nk-ten").value=""; qs("#nk-sl").value=""; qs("#nk-gia").value="";
  renderNhapKho();
}
function renderNhapKho(){
  const wrap=qs("#nk-list");
  if(!nhapkho.length){wrap.innerHTML="<i>Ch∆∞a nh·∫≠p kho</i>";return}
  let tong=0;
  let html=`<table><tr><th>Nguy√™n li·ªáu</th><th>SL</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th></tr>`;
  nhapkho.forEach(n=>{
    const tt=n.sl*n.gia; tong+=tt;
    html+=`<tr><td>${n.ten}</td><td>${n.sl}</td><td>${fmt.format(n.gia)}</td><td>${fmt.format(tt)}</td></tr>`;
  });
  html+=`<tr><th colspan="3">T·ªïng</th><th>${fmt.format(tong)}</th></tr></table>`;
  wrap.innerHTML=html;
}

/* ===== B√ÅO C√ÅO (l·ªçc theo th√°ng) ===== */
function renderReport(){
  // Thi·∫øt l·∫≠p m·∫∑c ƒë·ªãnh th√°ng hi·ªán t·∫°i n·∫øu ch∆∞a ch·ªçn
  const monthInput=qs("#report-month");
  if(!monthInput.value){
    const today=new Date();
    const v=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}`;
    monthInput.value=v;
  }
  const [y,m]=monthInput.value.split("-").map(Number);
  const monthStart=new Date(y, m-1, 1).getTime();
  const monthEnd=new Date(y, m, 1).getTime();

  // Danh s√°ch b√°n h√†ng trong th√°ng
  const soldMonth=sales.filter(s=>s.ts>=monthStart && s.ts<monthEnd);
  let htmlSales="<table><tr><th>M√≥n</th><th>SL</th><th>Th√†nh ti·ªÅn</th></tr>";
  if(soldMonth.length){
    soldMonth.forEach(s=>{htmlSales+=`<tr><td>${s.ten}</td><td>${s.sl}</td><td>${fmt.format(s.sl*s.gia)}</td></tr>`});
  }else{
    htmlSales+=`<tr><td colspan="3"><i>Kh√¥ng c√≥ d·ªØ li·ªáu</i></td></tr>`;
  }
  htmlSales+="</table>";
  qs("#report-sales").innerHTML=htmlSales;

  // T·ªïng h·ª£p Tu·∫ßn / Th√°ng / NƒÉm
  const today=new Date(); today.setHours(0,0,0,0);
  const weekStart=new Date(today); weekStart.setDate(weekStart.getDate()-weekStart.getDay()); // tu·∫ßn b·∫Øt ƒë·∫ßu Ch·ªß nh·∫≠t
  const yearStart=new Date(today.getFullYear(),0,1).getTime();

  const sumSales = fn => sales.filter(fn).reduce((a,b)=>a+b.sl*b.gia,0);
  const sumNhap  = fn => nhapkho.filter(fn).reduce((a,b)=>a+b.sl*b.gia,0);

  const dtWeek = sumSales(s=>s.ts>=weekStart.getTime());
  const cpWeek = sumNhap (n=>n.ts>=weekStart.getTime());
  const dtMonth= sumSales(s=>s.ts>=monthStart && s.ts<monthEnd);
  const cpMonth= sumNhap (n=>n.ts>=monthStart && n.ts<monthEnd);
  const dtYear = sumSales(s=>s.ts>=yearStart);
  const cpYear = sumNhap (n=>n.ts>=yearStart);

  const htmlSummary = `
    <table>
      <tr><th>Kho·∫£ng</th><th>Doanh thu</th><th>Chi ph√≠</th><th>L·ª£i nhu·∫≠n</th></tr>
      <tr><td>Tu·∫ßn</td><td>${fmt.format(dtWeek)}</td><td>${fmt.format(cpWeek)}</td><td>${fmt.format(dtWeek-cpWeek)}</td></tr>
      <tr><td>Th√°ng (${monthInput.value})</td><td>${fmt.format(dtMonth)}</td><td>${fmt.format(cpMonth)}</td><td>${fmt.format(dtMonth-cpMonth)}</td></tr>
      <tr><td>NƒÉm</td><td>${fmt.format(dtYear)}</td><td>${fmt.format(cpYear)}</td><td>${fmt.format(dtYear-cpYear)}</td></tr>
    </table>`;
  qs("#report-summary").innerHTML=htmlSummary;
}

/* ===== Init ===== */
(function init(){
  // M·∫∑c ƒë·ªãnh m·ªü tab B√°n h√†ng cho thao t√°c nhanh
  document.querySelectorAll("nav button")[1].classList.add("active");
  qs("#banhang").classList.remove("hidden");
  renderBanHang();
})();
</script>
</body>
</html>
