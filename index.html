<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRẠM CÀ PHÊ</title>
<style>
body{font-family:sans-serif;margin:0;background:#fafafa}
nav{display:flex;justify-content:space-around;background:#6f4e37;color:#fff}
nav button{flex:1;padding:14px;font-size:20px;border:none;background:inherit;color:#fff;cursor:pointer}
nav button.active{background:#8d6e63}
section{padding:15px}

/* menu bán hàng */
.menu-scroll{
  display:flex;flex-direction:column;align-items:center;
  gap:14px;padding:10px;
}
.menu-item{
  width:80%;padding:20px;font-size:24px;
  border:2px solid #6f4e37;border-radius:14px;
  background:#fff;text-align:center;cursor:pointer;user-select:none;
}
.menu-item:active{transform:scale(0.98)}
.menu-item:hover{background:#f0e6dd}

/* popup bán hàng */
.popup{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;
  z-index:1000;display:none;
}
.popup-content{
  background:#fff;padding:20px;border-radius:12px;width:300px;text-align:center;font-size:20px;
}
.popup-content input{font-size:22px;padding:8px;margin:12px 0;width:100%}

/* bảng */
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border:1px solid #ccc;padding:6px;text-align:center;font-size:18px}
.highlight{background:#fff3cd}

/* nút */
.btn{padding:10px 14px;font-size:18px;border:none;border-radius:6px;cursor:pointer}
.btn.primary{background:#1976d2;color:#fff}
.btn.danger{background:#d32f2f;color:#fff}
.btn.success{background:#388e3c;color:#fff}
</style>
</head>
<body>
<nav>
  <button onclick="openTab('banhang')" id="tab-banhang">Bán hàng</button>
  <button onclick="openTab('menu')">Menu</button>
  <button onclick="openTab('nhapkho')">Nhập kho</button>
  <button onclick="openTab('baocao')">Báo cáo</button>
  <button onclick="openTab('caidat')">Cài đặt</button>
</nav>

<!-- Bán hàng -->
<section id="banhang">
  <h2>Bán hàng</h2>
  <div class="menu-scroll" id="ban-grid"></div>
  <div id="sold-list"></div>
</section>

<!-- Menu -->
<section id="menu" class="hidden">
  <h2>Quản lý menu</h2>
  <div>
    <input id="new-ten" placeholder="Tên món">
    <input id="new-gia" type="number" placeholder="Giá">
    <button class="btn success" onclick="addMenu()">Thêm</button>
  </div>
  <table id="menu-table"></table>
  <div style="margin-top:12px">
    <input type="file" id="csv-file" accept=".csv">
    <button class="btn primary" onclick="importCSV()">Import CSV</button>
  </div>
</section>

<!-- Nhập kho -->
<section id="nhapkho" class="hidden">
  <h2>Quản lý nhập kho</h2>
  <div>
    <select id="nhap-ten"></select>
    <input type="number" id="nhap-sl" placeholder="Số lượng">
    <input type="number" id="nhap-gia" placeholder="Đơn giá">
    <button class="btn success" onclick="addNhap()">Nhập</button>
  </div>
  <table id="nhap-table"></table>
</section>

<!-- Báo cáo -->
<section id="baocao" class="hidden">
  <h2>Báo cáo</h2>
  <label for="report-month" style="font-size:20px;">Chọn tháng:</label>
  <input type="month" id="report-month" style="font-size:20px;padding:6px" onchange="renderReport()">
  
  <h3>Danh sách bán hàng trong tháng</h3>
  <div id="report-sales"></div>
  
  <h3>Doanh thu & Lợi nhuận (Tuần / Tháng / Năm)</h3>
  <div id="report-summary"></div>
</section>

<!-- Cài đặt -->
<section id="caidat" class="hidden">
  <h2>Cài đặt</h2>
  <button class="btn danger" onclick="clearData()">Xóa toàn bộ dữ liệu</button>
</section>

<!-- Popup nhập số lượng -->
<div id="sell-popup" class="popup">
  <div class="popup-content">
    <h3 id="popup-name"></h3>
    <p>Giá: <span id="popup-price"></span></p>
    <input type="number" id="popup-qty" min="1" value="1">
    <div style="margin-top:15px">
      <button class="btn primary" onclick="confirmSell()">Xác nhận</button>
      <button class="btn danger" onclick="closePopup()">Hủy</button>
    </div>
  </div>
</div>

<script>
const LS_MENU="menu",LS_SALES="sales",LS_NHAP="nhapkho";
let menu=JSON.parse(localStorage.getItem(LS_MENU)||"[]");
let sales=JSON.parse(localStorage.getItem(LS_SALES)||"[]");
let nhapkho=JSON.parse(localStorage.getItem(LS_NHAP)||"[]");
let currentItem=null,lastSoldId=null;
const fmt=new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"});

function qs(id){return document.querySelector(id)}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}

function openTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  qs("#"+id).classList.remove("hidden");
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  if(id==="banhang"){qs("#tab-banhang").classList.add("active");renderBanHang();}
  if(id==="menu")renderMenu();
  if(id==="nhapkho")renderNhap();
  if(id==="baocao")renderReport();
}

// Bán hàng
function renderBanHang(){
  const grid=qs("#ban-grid"); grid.innerHTML="";
  menu.forEach(m=>{
    const div=document.createElement("div");
    div.className="menu-item";
    div.textContent=m.ten;
    div.onclick=()=>openPopup(m);
    grid.appendChild(div);
  });
  renderSold();
}
function openPopup(item){
  currentItem=item;
  qs("#popup-name").textContent=item.ten;
  qs("#popup-price").textContent=fmt.format(item.gia);
  qs("#popup-qty").value=1;
  qs("#sell-popup").style.display="flex";
}
function closePopup(){qs("#sell-popup").style.display="none";}
function confirmSell(){
  const sl=+qs("#popup-qty").value;
  if(isNaN(sl)||sl<1){alert("Số lượng không hợp lệ");return;}
  const ts=Date.now(),id="s"+ts;
  sales.push({id,ten:currentItem.ten,gia:currentItem.gia,sl,ts});
  save(LS_SALES,sales);
  lastSoldId=id; closePopup(); renderSold();
}
function renderSold(){
  const today=new Date(); today.setHours(0,0,0,0);
  const sold=sales.filter(s=>s.ts>=today.getTime());
  const list=qs("#sold-list");
  if(!sold.length){list.innerHTML="<i>Chưa bán hôm nay</i>";return}
  let tong=0,html="<h3>Đã bán hôm nay</h3><table><tr><th>Món</th><th>SL</th><th>Thành tiền</th><th></th></tr>";
  sold.forEach((s,idx)=>{
    const tt=s.sl*s.gia; tong+=tt;
    const hl=(s.id===lastSoldId)?"highlight":"";
    html+=`<tr class="${hl}">
      <td>${s.ten}</td>
      <td><input type="number" value="${s.sl}" min="1" style="font-size:18px;width:70px"
          onchange="editSold(${idx},this.value)"></td>
      <td>${fmt.format(tt)}</td>
      <td><button class="btn danger" onclick="removeSold(${idx})">X</button></td>
    </tr>`;
  });
  html+=`<tr><th colspan=2>Tổng</th><th>${fmt.format(tong)}</th><th></th></tr></table>`;
  list.innerHTML=html;
}
function editSold(i,val){
  val=+val;if(isNaN(val)||val<1){alert("Số lượng không hợp lệ");renderSold();return;}
  const today=new Date(); today.setHours(0,0,0,0);
  const sold=sales.filter(s=>s.ts>=today.getTime());
  const globalIndex=sales.indexOf(sold[i]);
  sales[globalIndex].sl=val; save(LS_SALES,sales); renderSold();
}
function removeSold(i){
  const today=new Date(); today.setHours(0,0,0,0);
  const sold=sales.filter(s=>s.ts>=today.getTime());
  const globalIndex=sales.indexOf(sold[i]);
  sales.splice(globalIndex,1); save(LS_SALES,sales); renderSold();
}

// Menu
function renderMenu(){
  let html="<tr><th>Tên</th><th>Giá</th><th></th></tr>";
  menu.forEach((m,i)=>{
    html+=`<tr><td>${m.ten}</td>
    <td><input type="number" value="${m.gia}" onchange="editGia(${i},this.value)"></td>
    <td><button class="btn danger" onclick="delMenu(${i})">X</button></td></tr>`;
  });
  qs("#menu-table").innerHTML=html;
  let opt=""; menu.forEach(m=>opt+=`<option>${m.ten}</option>`); qs("#nhap-ten").innerHTML=opt;
}
function addMenu(){
  const ten=qs("#new-ten").value.trim();const gia=+qs("#new-gia").value;
  if(!ten||isNaN(gia)||gia<=0)return alert("Sai dữ liệu");
  menu.push({ten,gia});save(LS_MENU,menu);qs("#new-ten").value="";qs("#new-gia").value="";renderMenu();
}
function editGia(i,val){val=+val;if(val>0){menu[i].gia=val;save(LS_MENU,menu);}}
function delMenu(i){menu.splice(i,1);save(LS_MENU,menu);renderMenu();}
function importCSV(){
  const file=qs("#csv-file").files[0];if(!file)return;
  const r=new FileReader();r.onload=e=>{
    const lines=e.target.result.split(/\r?\n/);
    lines.forEach(l=>{const p=l.split(",");if(p.length>=2){const ten=p[0].trim();const gia=+p[1];if(ten&&gia>0)menu.push({ten,gia});}});
    save(LS_MENU,menu);renderMenu();
  };r.readAsText(file);
}

// Nhập kho
function renderNhap(){
  let html="<tr><th>Món</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th></tr>";
  nhapkho.forEach(n=>html+=`<tr><td>${n.ten}</td><td>${n.sl}</td><td>${fmt.format(n.gia)}</td><td>${fmt.format(n.sl*n.gia)}</td></tr>`);
  qs("#nhap-table").innerHTML=html;
}
function addNhap(){
  const ten=qs("#nhap-ten").value,sl=+qs("#nhap-sl").value,gia=+qs("#nhap-gia").value;
  if(!ten||sl<=0||gia<=0)return alert("Sai dữ liệu");
  nhapkho.push({ten,sl,gia,ts:Date.now()});save(LS_NHAP,nhapkho);
  qs("#nhap-sl").value="";qs("#nhap-gia").value="";renderNhap();
}

// Báo cáo
function renderReport(){
  const monthInput=qs("#report-month").value;
  let monthStart,monthEnd;
  if(monthInput){
    const [y,m]=monthInput.split("-").map(Number);
    monthStart=new Date(y,m-1,1);monthEnd=new Date(y,m,1);
  }else{
    const today=new Date();monthStart=new Date(today.getFullYear(),today.getMonth(),1);
    monthEnd=new Date(today.getFullYear(),today.getMonth()+1,1);
    qs("#report-month").value=today.toISOString().slice(0,7);
  }
  const soldMonth=sales.filter(s=>s.ts>=monthStart.getTime()&&s.ts<monthEnd.getTime());
  let htmlSales="<table><tr><th>Món</th><th>SL</th><th>Thành tiền</th></tr>";
  soldMonth.forEach(s=>htmlSales+=`<tr><td>${s.ten}</td><td>${s.sl}</td><td>${fmt.format(s.sl*s.gia)}</td></tr>`);
  htmlSales+="</table>";qs("#report-sales").innerHTML=htmlSales||"<i>Không có dữ liệu</i>";

  const today=new Date();today.setHours(0,0,0,0);
  const weekStart=new Date(today);weekStart.setDate(weekStart.getDate()-weekStart.getDay());
  const yearStart=new Date(today.getFullYear(),0,1);
  function sumSales(fn){return sales.filter(fn).reduce((a,b)=>a+b.sl*b.gia,0);}
  function sumNhap(fn){return nhapkho.filter(fn).reduce((a,b)=>a+b.sl*b.gia,0);}
  const htmlSummary=`<table>
    <tr><th>Khoảng</th><th>Doanh thu</th><th>Chi phí</th><th>Lợi nhuận</th></tr>
    <tr><td>Tuần</td><td>${fmt.format(sumSales(s=>s.ts>=weekStart.getTime()))}</td>
        <td>${fmt.format(sumNhap(n=>n.ts>=weekStart.getTime()))}</td>
        <td>${fmt.format(sumSales(s=>s.ts>=weekStart.getTime())-sumNhap(n=>n.ts>=weekStart.getTime()))}</td></tr>
    <tr><td>Tháng (${qs("#report-month").value})</td>
        <td>${fmt.format(sumSales(s=>s.ts>=monthStart.getTime() && s.ts<monthEnd.getTime()))}</td>
        <td>${fmt.format(sumNhap(n=>n.ts>=monthStart.getTime() && n.ts<monthEnd.getTime()))}</td>
        <td>${fmt.format(sumSales(s=>s.ts>=monthStart.getTime()&&s.ts<monthEnd.getTime())-sumNhap(n=>n.ts>=monthStart.getTime()&&n.ts<monthEnd.getTime()))}</td></tr>
    <tr><td>Năm</td><td>${fmt.format(sumSales(s=>s.ts>=yearStart.getTime()))}</td>
        <td>${fmt.format(sumNhap(n=>n.ts>=yearStart.getTime()))}</td>
        <td>${fmt.format(sumSales(s=>s.ts>=yearStart.getTime())-sumNhap(n=>n.ts>=yearStart.getTime()))}</td></tr>
  </table>`;
  qs("#report-summary").innerHTML=htmlSummary;
}

// Cài đặt
function clearData(){
  if(confirm("Xóa toàn bộ dữ liệu?")){
    localStorage.clear();menu=[];sales=[];nhapkho=[];
    renderMenu();renderNhap();renderSold();alert("Đã xóa dữ liệu!");
  }
}

// Khởi tạo
openTab("banhang");
</script>
</body>
</html>
